<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Modulo de Seguimiento â€” BlueSphere</title>
<meta name="description" content="Sistema completo de seguimiento ambiental con 18 acciones, medallas y conexiÃ³n directa a Supabase" />
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
<style>
  :root{
    --bg:#041016; --card:#07212a; --accent:#4fc3f7; --muted:#c8eaff;
    --success:#3ddc84; --gold:#ffd700; --warning:#ffb74d; --white:#ffffff;
  }
  body{font-family:Inter, Arial, sans-serif; background:var(--bg); color:var(--white); margin:0; padding:20px;}
  .wrap{max-width:980px;margin:16px auto;}
  .card{background:var(--card); border-radius:12px; padding:18px; border:1px solid rgba(127,206,255,0.04);}
  h1{color:var(--accent); margin:0 0 8px; font-size:1.5rem;}
  p.lead{color:var(--muted); margin:6px 0 18px;}
  .flex{display:flex; gap:12px; align-items:center; flex-wrap:wrap;}
  .input, textarea, select{width:100%; padding:10px; border-radius:8px; border:1px solid #19434d; background:#021219; color:var(--white); box-sizing:border-box;}
  label{display:block; color:var(--muted); margin-bottom:6px; font-weight:700;}
  .small{font-size:0.9rem; color:var(--muted);}
  .grid{display:grid; grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); gap:12px;}
  .btn{padding:10px 14px; border-radius:10px; cursor:pointer; border:0; font-weight:800;}
  .btn-primary{background:linear-gradient(135deg,var(--accent),#81d4fa); color:#041016;}
  .btn-success{background:var(--success); color:#041016;}
  .btn-warning{background:var(--warning); color:#041016;}
  .btn-plain{background:transparent; border:1px solid rgba(255,255,255,0.06); color:var(--muted);}
  .hint{font-size:0.85rem; color:var(--muted); margin-top:8px;}
  .kpi{display:flex; gap:8px; align-items:center;}
  .badge{display:inline-block; padding:6px 8px; border-radius:999px; background:rgba(255,255,255,0.03); color:var(--muted); font-weight:700;}
  .success-box{background:linear-gradient(90deg, rgba(61,220,132,0.08), rgba(127,206,255,0.02)); padding:12px; border-radius:8px; color:var(--white); margin-top:12px;}
  .warning-box{background:linear-gradient(90deg, rgba(255,183,77,0.08), rgba(127,206,255,0.02)); padding:12px; border-radius:8px; color:var(--white); margin-top:12px;}
  .history-item{background:rgba(255,255,255,0.02); padding:10px; border-radius:8px; margin-bottom:8px; border-left:3px solid var(--accent);}
  .files-list{margin-top:8px;}
  .tiny{font-size:0.8rem; color:var(--muted);}
  .center{text-align:center;}
  a.link{color:var(--accent); text-decoration:none;}
   
  /* Nuevos estilos para secciones */
  .section-title {
    color: var(--accent);
    font-size: 1.1rem;
    margin: 20px 0 10px 0;
    padding-bottom: 8px;
    border-bottom: 2px solid rgba(79, 195, 247, 0.3);
  }
   
  .action-group {
    background: rgba(255,255,255,0.02);
    padding: 15px;
    border-radius: 8px;
    margin: 15px 0;
    border: 1px solid rgba(255,255,255,0.05);
  }
   
  .medalla-item {
    background: linear-gradient(135deg, rgba(255,215,0,0.1), rgba(255,255,255,0.02));
    padding: 12px;
    border-radius: 8px;
    margin: 8px 0;
    border-left: 4px solid #FFD700;
  }
   
  .loader {
    border: 3px solid rgba(255,255,255,0.1);
    border-top: 3px solid var(--accent);
    border-radius: 50%;
    width: 30px;
    height: 30px;
    animation: spin 1s linear infinite;
    margin: 0 auto;
  }
   
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
   
  .hidden { display: none !important; }
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>ğŸ” Seguimiento Completo â€” BlueSphere</h1>
      <p class="lead">Registra tus acciones ambientales. Sistema con 18 opciones, medallas y seguimiento en tiempo real.</p>

      <div style="margin-bottom:12px;">
        <label for="codigoInput">Tu CÃ³digo de GuardiÃ¡n</label>
        <input id="codigoInput" class="input" placeholder="Ej: GPR-AQUA-ZIRIUX-000050">
        <div class="hint">Si vienes del Portal Azul, el cÃ³digo ya deberÃ­a estar cargado automÃ¡ticamente.</div>
      </div>

      <div class="flex" style="margin-bottom:12px;">
        <div class="kpi"><span class="badge">Estado</span> <div id="estadoBadge" style="margin-left:8px;" class="tiny">Ingresa tu cÃ³digo</div></div>
        <div class="kpi"><span class="badge">Registros</span> <div id="numCheckins" style="margin-left:8px;" class="tiny">0</div></div>
        <div class="kpi"><span class="badge">Impacto total</span> <div id="impactoTotal" style="margin-left:8px;" class="tiny">0 kg COâ‚‚</div></div>
        <div class="kpi"><span class="badge">Medallas</span> <div id="numMedallas" style="margin-left:8px;" class="tiny">0</div></div>
      </div>

      <button id="btnCargar" class="btn btn-plain" style="width:100%; margin-bottom:15px;">
        ğŸ” Cargar mi Perfil y Historial
      </button>

      <form id="seguimientoForm" class="card" style="margin-top:12px;">
        
        <div class="section-title">ğŸš€ Acciones Diarias / BÃ¡sicas</div>
        <div class="action-group">
          <div class="grid">
            <label><input type="checkbox" class="accion-chk" value="menos_plastico"> ğŸ¥¤ ReducciÃ³n de plÃ¡sticos</label>
            <label><input type="checkbox" class="accion-chk" value="transporte_limpio"> ğŸš² Transporte sostenible</label>
            <label><input type="checkbox" class="accion-chk" value="ahorro_agua"> ğŸ’§ ConservaciÃ³n de agua</label>
            <label><input type="checkbox" class="accion-chk" value="consumo_local"> ğŸŒ± Consumo responsable</label>
            <label><input type="checkbox" class="accion-chk" value="reciclaje"> â™»ï¸ Reciclaje correcto</label>
            <label><input type="checkbox" class="accion-chk" value="digital_limpio"> ğŸ“µ Digital sostenible</label>
            <label><input type="checkbox" class="accion-chk" value="sin_desperdicio"> ğŸƒ Comida sin desperdicio</label>
            <label><input type="checkbox" class="accion-chk" value="energia_ahorro"> ğŸ”‹ Ahorro de energÃ­a</label>
          </div>
        </div>
        
        <div class="section-title">ğŸŒŸ Acciones de Alto Impacto</div>
        <div class="action-group">
          <div class="grid">
            <label><input type="checkbox" class="accion-chk" value="limpieza_natural"> ğŸ–ï¸ Limpieza de espacios naturales</label>
            <label><input type="checkbox" class="accion-chk" value="compra_consciente"> ğŸ›’ Compra consciente</label>
            <label><input type="checkbox" class="accion-chk" value="dia_sin_carne"> ğŸŒ¿ DÃ­a sin carne</label>
            <label><input type="checkbox" class="accion-chk" value="activismo_digital"> ğŸ“¢ Activismo digital</label>
            <label><input type="checkbox" class="accion-chk" value="reforestacion"> ğŸŒ³ ReforestaciÃ³n/PlantaciÃ³n</label>
            <label><input type="checkbox" class="accion-chk" value="productos_ecologicos"> ğŸ§´ Productos ecolÃ³gicos</label>
            <label><input type="checkbox" class="accion-chk" value="voluntariado"> ğŸ¤ Voluntariado ambiental</label>
            <label><input type="checkbox" class="accion-chk" value="reparar_objetos"> ğŸ§© Reparar antes de tirar</label>
            <label><input type="checkbox" class="accion-chk" value="formacion_ambiental"> ğŸ“š FormaciÃ³n ambiental</label>
            <label><input type="checkbox" class="accion-chk" value="jardin_polinizadores"> ğŸ JardÃ­n para polinizadores</label>
          </div>
        </div>

        <div style="margin-bottom:12px;">
          <label>Frecuencia</label>
          <select id="frecuencia" class="input">
            <option value="Semanal">Semanal</option>
            <option value="Diaria">Diaria</option>
            <option value="Ocasional">Ocasional</option>
            <option value="Primera vez">Primera vez</option>
          </select>
        </div>

        <div style="margin-bottom:12px;">
          <label>Â¿Subes evidencia? (foto o ticket) â€” opcional</label>
          <input id="fileInput" type="file" accept="image/*,application/pdf" style="padding:6px; background:#021219; color:var(--white); border-radius:8px;">
          <div id="filesPreview" class="files-list tiny"></div>
          <div class="tiny hint">Una foto clara o ticket ayuda a validar y aumenta el impacto verificado.</div>
        </div>

        <div style="margin-bottom:12px;">
          <label>Comentario o reflexiÃ³n (opcional)</label>
          <textarea id="comentario" class="input" rows="3" placeholder="Â¿QuÃ© hiciste? Â¿DÃ³nde? Â¿CÃ³mo te sentiste?"></textarea>
        </div>
        
        <div style="margin-bottom:12px;">
          <label>Impacto estimado (kg COâ‚‚ evitados)</label>
          <input type="number" id="impactoCo2" class="input" value="2.5" step="0.1" min="0">
        </div>

        <div style="display:flex; gap:10px; align-items:center; margin-top:6px;">
          <button id="btnEnviar" class="btn btn-primary" type="button">ğŸš€ Registrar Impacto</button>
          <button id="btnGuardarBorrador" class="btn btn-plain" type="button">ğŸ’¾ Guardar borrador</button>
          <div style="flex:1"></div>
          <div id="contadorAcciones" class="tiny">Acciones: <strong>0</strong></div>
        </div>

        <div id="mensaje" class="hint" style="margin-top:12px; display:none;"></div>
      </form>
      
      <div id="loaderBox" class="center hidden" style="margin:20px 0;">
        <div class="loader"></div>
        <div class="tiny" style="margin-top:10px;">Procesando...</div>
      </div>

      <div id="resultadoBox" style="display:none; margin-top:14px;">
        <div class="success-box center">
          <div style="font-weight:800; font-size:1.05rem;">âœ… Â¡Impacto Registrado!</div>
          <div id="resultadoImpacto" style="margin-top:8px;" class="tiny"></div>
          <div id="nuevaMedallaBox" style="margin-top:10px;" class="hidden"></div>
          <div style="margin-top:12px;">
            <button id="btnVerDashboard" class="btn btn-success">ğŸŒ Ver en Dashboard</button>
          </div>
        </div>
      </div>

      <div id="medallasBox" class="hidden" style="margin-top:20px;">
        <div class="card">
          <h3 style="color:var(--accent); margin-bottom:12px;">ğŸ† Tus Logros y Medallas</h3>
          <div id="medallasLista" class="tiny">
            </div>
          <div id="proximasMedallas" class="warning-box" style="margin-top:15px;">
            <h4 style="color:var(--warning); margin-bottom:8px;">ğŸ¯ PrÃ³ximos Objetivos</h4>
            <div id="proximasLista" class="tiny"></div>
          </div>
        </div>
      </div>

      <div id="historialBox" class="hidden" style="margin-top:20px;">
        <h3 style="color:var(--accent); margin-bottom:8px;">ğŸ“Š Historial de Impacto</h3>
        <div id="historyBox" class="small">
          <div class="tiny">Cargando historial...</div>
        </div>
      </div>

    </div>

    <div style="height:18px;"></div>

    <div class="card small">
      <strong>ğŸ”— Sistema Conectado</strong>
      <ul>
        <li><strong>Base de datos:</strong> Supabase (tabla 'seguimiento')</li>
        <li><strong>Dashboard:</strong> Datos en tiempo real</li>
        <li><strong>Medallas:</strong> Sistema automÃ¡tico de reconocimiento</li>
        <li><strong>Impacto:</strong> CÃ¡lculo en kg COâ‚‚ evitados</li>
      </ul>
    </div>

  </div>

<script>
// ================= CONFIGURACIÃ“N SUPABASE =================
const SUPABASE_URL = 'https://ophicpcbgdgzthjamzoz.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9waGljcGNiZ2RnenRoamFtem96Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ3MjgwMzUsImV4cCI6MjA4MDMwNDAzNX0.K55Tk-cdbAFDOtGrIMN7vYFaJAccrsD6UdOrARt1P5c';

// Inicializar Supabase
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// Sistema de medallas
const MEDALLAS = {
  'primer_paso': {
    nombre: 'ğŸŒ± Primer Paso',
    descripcion: 'Completaste tu primer registro de impacto',
    criterio: (registros) => registros.length >= 1,
    icono: 'ğŸŒ±'
  },
  'compromiso_7d': {
    nombre: 'ğŸ”¥ Compromiso Inicial',
    descripcion: '7 dÃ­as consecutivos de acciones',
    criterio: (registros) => calcularDiasConsecutivos(registros) >= 7,
    icono: 'ğŸ”¥'
  },
  'guardiÃ¡n_activo': {
    nombre: 'ğŸ›¡ï¸ GuardiÃ¡n Activo',
    descripcion: '15 registros de acciones ambientales',
    criterio: (registros) => registros.length >= 15,
    icono: 'ğŸ›¡ï¸'
  },
  'excelencia_azul': {
    nombre: 'â­ Excelencia Azul',
    descripcion: '30 registros de impacto consistente',
    criterio: (registros) => registros.length >= 30,
    icono: 'â­'
  },
  'impacto_alto': {
    nombre: 'ğŸ’ Impacto Alto',
    descripcion: '100+ kg de COâ‚‚ evitados acumulados',
    criterio: (registros) => calcularImpactoTotal(registros) >= 100,
    icono: 'ğŸ’'
  },
  'evidencia_pro': {
    nombre: 'ğŸ“¸ Verificador Pro',
    descripcion: '5+ registros con evidencia fotogrÃ¡fica',
    criterio: (registros) => registros.filter(r => r.evidencia_urls && r.evidencia_urls.length > 0).length >= 5,
    icono: 'ğŸ“¸'
  }
};

// Variables globales
let usuarioCodigo = '';
let historialRegistros = [];

// ================= FUNCIONES PRINCIPALES =================
async function cargarPerfil() {
  usuarioCodigo = document.getElementById('codigoInput').value.trim();
   
  if (!usuarioCodigo) {
    mostrarMensaje('âš ï¸ Ingresa tu cÃ³digo de guardiÃ¡n', 'warning');
    return;
  }
   
  mostrarLoader(true);
   
  // VALIDACIÃ“N OPTIMIZADA PARA ZIRIUX (Acepta cualquier cÃ³digo mayor a 8 caracteres)
  const codigoValido = usuarioCodigo.length > 8;
   
  if (codigoValido) {
    document.getElementById('estadoBadge').textContent = 'âœ… CÃ³digo vÃ¡lido';
    document.getElementById('estadoBadge').style.color = '#3ddc84';
    
    // Cargar historial
    await cargarHistorial(usuarioCodigo);
    
    // Mostrar secciones
    document.getElementById('historialBox').classList.remove('hidden');
    document.getElementById('medallasBox').classList.remove('hidden');
    
  } else {
    document.getElementById('estadoBadge').textContent = 'âŒ CÃ³digo invÃ¡lido';
    document.getElementById('estadoBadge').style.color = '#ff7b7b';
    mostrarMensaje('El cÃ³digo ingresado no es vÃ¡lido', 'error');
  }
   
  mostrarLoader(false);
}

async function cargarHistorial(codigo) {
  try {
    const { data, error } = await supabase
      .from('seguimiento')
      .select('*')
      .eq('codigo_guardian', codigo)
      .order('fecha_reporte', { ascending: false });
    
    if (error) throw error;
    
    historialRegistros = data || [];
    
    // Actualizar estadÃ­sticas
    document.getElementById('numCheckins').textContent = historialRegistros.length;
    
    const impactoTotal = calcularImpactoTotal(historialRegistros);
    document.getElementById('impactoTotal').textContent = `${impactoTotal.toFixed(1)} kg COâ‚‚`;
    
    // Mostrar historial
    const historyBox = document.getElementById('historyBox');
    
    if (historialRegistros.length > 0) {
      historyBox.innerHTML = historialRegistros.map(item => `
        <div class="history-item">
          <div style="font-weight:700; color:var(--accent); margin-bottom:4px;">
            ${new Date(item.fecha_reporte).toLocaleDateString('es-ES', { 
              weekday: 'short', 
              year: 'numeric', 
              month: 'short', 
              day: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
            })}
          </div>
          <div style="margin-bottom:6px;">${item.acciones_realizadas || 'Acciones registradas'}</div>
          <div style="color:#81d4fa; font-size:0.85rem;">
            ğŸŒ¿ ${item.impacto_co2 ? item.impacto_co2 + ' kg COâ‚‚ evitados' : 'Impacto registrado'}
          </div>
          ${item.comentario ? `<div class="tiny" style="margin-top:6px; font-style:italic;">"${item.comentario}"</div>` : ''}
        </div>
      `).join('');
    } else {
      historyBox.innerHTML = '<div class="tiny">No hay registros previos. Â¡SÃ© el primero en marcar la diferencia!</div>';
    }
    
    // Actualizar medallas
    actualizarMedallas(historialRegistros);
    
  } catch (error) {
    console.error('Error cargando historial:', error);
    document.getElementById('historyBox').innerHTML = 
      '<div class="tiny">No se pudo cargar el historial. Intenta nuevamente.</div>';
  }
}

async function registrarImpacto() {
  if (!usuarioCodigo) {
    mostrarMensaje('Primero carga tu perfil con tu cÃ³digo', 'warning');
    return;
  }
   
  // Recoger acciones seleccionadas
  let acciones = [];
  document.querySelectorAll('.accion-chk:checked').forEach(c => {
    acciones.push(c.value);
  });
   
  if (acciones.length === 0) {
    mostrarMensaje('Selecciona al menos una acciÃ³n realizada', 'warning');
    return;
  }
   
  const frecuencia = document.getElementById('frecuencia').value;
  const comentario = document.getElementById('comentario').value.trim();
  const impactoCo2 = parseFloat(document.getElementById('impactoCo2').value) || 2.5;
   
  mostrarLoader(true);
   
  try {
    // Guardar en Supabase
    const { error } = await supabase
      .from('seguimiento')
      .insert([{
        codigo_guardian: usuarioCodigo,
        acciones_realizadas: acciones.join(', '),
        frecuencia: frecuencia,
        comentario: comentario,
        impacto_co2: impactoCo2,
        fecha_reporte: new Date().toISOString()
      }]);
    
    if (error) throw error;
    
    // Ã‰xito
    mostrarMensaje('âœ… Impacto registrado exitosamente', 'success');
    
    // Mostrar resultado
    document.getElementById('resultadoBox').style.display = 'block';
    document.getElementById('resultadoImpacto').textContent = 
      `Impacto registrado: ${impactoCo2} kg COâ‚‚ evitados`;
    
    // Limpiar formulario
    document.querySelectorAll('.accion-chk').forEach(cb => cb.checked = false);
    document.getElementById('comentario').value = '';
    document.getElementById('impactoCo2').value = '2.5';
    
    // Actualizar historial
    await cargarHistorial(usuarioCodigo);
    
  } catch (error) {
    console.error('Error registrando impacto:', error);
    mostrarMensaje('âŒ Error al guardar. Intenta nuevamente.', 'error');
  } finally {
    mostrarLoader(false);
  }
}

function actualizarMedallas(registros) {
  const medallasGanadas = [];
  const medallasLista = document.getElementById('medallasLista');
  const numMedallas = document.getElementById('numMedallas');
  const proximasLista = document.getElementById('proximasLista');
   
  // Verificar cada medalla
  for (const [id, medalla] of Object.entries(MEDALLAS)) {
    if (medalla.criterio(registros)) {
      medallasGanadas.push(medalla);
    }
  }
   
  // Mostrar medallas ganadas
  if (medallasGanadas.length > 0) {
    medallasLista.innerHTML = medallasGanadas.map(medalla => `
      <div class="medalla-item">
        <div style="font-weight:700;">${medalla.icono} ${medalla.nombre}</div>
        <div class="tiny">${medalla.descripcion}</div>
      </div>
    `).join('');
  } else {
    medallasLista.innerHTML = '<div class="tiny">AÃºn no has ganado medallas. Â¡Sigue registrando tus acciones!</div>';
  }
   
  // Actualizar contador
  numMedallas.textContent = medallasGanadas.length;
   
  // Mostrar prÃ³ximas medallas
  const proximas = [];
  const totalRegistros = registros.length;
  const diasConsecutivos = calcularDiasConsecutivos(registros);
  const impactoTotal = calcularImpactoTotal(registros);
   
  if (totalRegistros < 15) proximas.push(`ğŸ›¡ï¸ GuardiÃ¡n Activo en ${15 - totalRegistros} registros mÃ¡s`);
  if (totalRegistros < 30) proximas.push(`â­ Excelencia Azul en ${30 - totalRegistros} registros mÃ¡s`);
  if (diasConsecutivos < 7) proximas.push(`ğŸ”¥ Compromiso Inicial en ${7 - diasConsecutivos} dÃ­as consecutivos`);
  if (impactoTotal < 100) proximas.push(`ğŸ’ Impacto Alto en ${(100 - impactoTotal).toFixed(1)} kg COâ‚‚ mÃ¡s`);
   
  if (proximas.length > 0) {
    proximasLista.innerHTML = proximas.map(p => `<div style="margin-bottom:6px;">â€¢ ${p}</div>`).join('');
  } else {
    proximasLista.innerHTML = '<div>Â¡Ya lograste todos los objetivos principales! ğŸ‰</div>';
  }
}

// ================= FUNCIONES DE UTILIDAD =================
function calcularDiasConsecutivos(registros) {
  if (registros.length === 0) return 0;
   
  const fechasUnicas = [...new Set(registros.map(r => 
    new Date(r.fecha_reporte).toISOString().split('T')[0]
  ))].sort().reverse();
   
  let consecutivos = 1;
  for (let i = 1; i < fechasUnicas.length; i++) {
    const fechaActual = new Date(fechasUnicas[i-1]);
    const fechaAnterior = new Date(fechasUnicas[i]);
    const diferenciaDias = (fechaActual - fechaAnterior) / (1000 * 60 * 60 * 24);
    
    if (diferenciaDias === 1) {
      consecutivos++;
    } else {
      break;
    }
  }
   
  return consecutivos;
}

function calcularImpactoTotal(registros) {
  return registros.reduce((total, item) => total + (item.impacto_co2 || 0), 0);
}

function mostrarMensaje(texto, tipo = 'info') {
  const mensajeBox = document.getElementById('mensaje');
  mensajeBox.textContent = texto;
  mensajeBox.style.color = tipo === 'success' ? '#3ddc84' : 
                          tipo === 'warning' ? '#ffb74d' : '#ff7b7b';
  mensajeBox.style.display = 'block';
   
  setTimeout(() => {
    mensajeBox.style.display = 'none';
  }, 5000);
}

function mostrarLoader(mostrar) {
  document.getElementById('loaderBox').classList.toggle('hidden', !mostrar);
}

// ================= INICIALIZACIÃ“N (CORREGIDA) =================
document.addEventListener('DOMContentLoaded', function() {
  console.log('MÃ³dulo de Seguimiento BlueSphere - Inicializado');
  
  // 1. PRIMERO: Cargar borrador si existe (Baja Prioridad)
  const borrador = localStorage.getItem('bluesphere_borrador');
  if (borrador) {
    try {
      const estado = JSON.parse(borrador);
      if (estado.codigo) document.getElementById('codigoInput').value = estado.codigo;
      if (estado.acciones) {
        document.querySelectorAll('.accion-chk').forEach(cb => {
          cb.checked = estado.acciones.includes(cb.value);
        });
      }
      if (estado.frecuencia) document.getElementById('frecuencia').value = estado.frecuencia;
      if (estado.comentario) document.getElementById('comentario').value = estado.comentario;
      if (estado.impacto) document.getElementById('impactoCo2').value = estado.impacto;
    } catch (e) {
      console.warn('Error cargando borrador:', e);
    }
  }

  // 2. SEGUNDO: Auto-cargar cÃ³digo de URL (ALTA PRIORIDAD - Sobrescribe el borrador)
  const params = new URLSearchParams(window.location.search);
  const codigoURL = params.get('codigo');
   
  if (codigoURL) {
    console.log("Detectado cÃ³digo en URL:", codigoURL);
    document.getElementById('codigoInput').value = codigoURL;
    
    // Auto-login con el cÃ³digo de la URL
    setTimeout(() => {
      cargarPerfil();
    }, 800);
  }
   
  // Event Listeners
  document.getElementById('btnCargar').addEventListener('click', cargarPerfil);
  document.getElementById('btnEnviar').addEventListener('click', registrarImpacto);
   
  document.getElementById('btnGuardarBorrador').addEventListener('click', function() {
    const estado = {
      codigo: document.getElementById('codigoInput').value,
      acciones: Array.from(document.querySelectorAll('.accion-chk:checked')).map(c => c.value),
      frecuencia: document.getElementById('frecuencia').value,
      comentario: document.getElementById('comentario').value,
      impacto: document.getElementById('impactoCo2').value
    };
    localStorage.setItem('bluesphere_borrador', JSON.stringify(estado));
    mostrarMensaje('ğŸ’¾ Borrador guardado localmente', 'success');
  });
   
  document.getElementById('btnVerDashboard').addEventListener('click', function() {
    window.open('dashboard-global-impacto.html', '_blank');
  });
   
  // Calcular impacto automÃ¡tico
  document.querySelectorAll('.accion-chk').forEach(checkbox => {
    checkbox.addEventListener('change', function() {
      const checked = document.querySelectorAll('.accion-chk:checked');
      document.getElementById('contadorAcciones').innerHTML = `Acciones: <strong>${checked.length}</strong>`;
       
      // Calcular impacto estimado
      let impactoTotal = 0;
      checked.forEach(cb => {
        const valor = cb.value;
        // Acciones avanzadas valen mÃ¡s
        if (valor.includes('limpieza') || valor.includes('reforestacion') || 
            valor.includes('voluntariado') || valor.includes('activismo')) {
          impactoTotal += 1.5;
        } else if (valor.includes('compra') || valor.includes('productos') || 
                   valor.includes('formacion')) {
          impactoTotal += 1.0;
        } else {
          impactoTotal += 0.5;
        }
      });
       
      document.getElementById('impactoCo2').value = impactoTotal.toFixed(1);
    });
  });
   
  // Preview de archivo
  document.getElementById('fileInput').addEventListener('change', function(e) {
    const file = e.target.files[0];
    const preview = document.getElementById('filesPreview');
     
    if (file) {
      preview.textContent = `ğŸ“ ${file.name} (${Math.round(file.size / 1024)} KB)`;
    } else {
      preview.textContent = '';
    }
  });
});

// Exportar funciones al scope global
window.cargarPerfil = cargarPerfil;
window.registrarImpacto = registrarImpacto;
</script>
</body>
</html>
