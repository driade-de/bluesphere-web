<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>M√≥dulo de Seguimiento ‚Äî BlueSphere</title>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
  /* ESTILOS ORIGINALES (GHIBLI DARK) */
  :root{ --bg:#041016; --card:#07212a; --accent:#4fc3f7; --muted:#c8eaff; --success:#3ddc84; --gold:#ffd700; --white:#ffffff; }
  body{font-family:Inter, Arial, sans-serif; background:var(--bg); color:var(--white); margin:0; padding:20px;}
  .wrap{max-width:980px;margin:16px auto;}
  .card{background:var(--card); border-radius:12px; padding:18px; border:1px solid rgba(127,206,255,0.04);}
  h1{color:var(--accent); margin:0 0 8px; font-size:1.5rem;}
  p.lead{color:var(--muted); margin:6px 0 18px;}
  .flex{display:flex; gap:12px; align-items:center; flex-wrap:wrap;}
  .input, textarea, select{width:100%; padding:10px; border-radius:8px; border:1px solid #19434d; background:#021219; color:var(--white); box-sizing:border-box;}
  label{display:block; color:var(--muted); margin-bottom:6px; font-weight:700;}
  .small{font-size:0.9rem; color:var(--muted);}
  .grid{display:grid; grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); gap:12px;}
  .btn{padding:10px 14px; border-radius:10px; cursor:pointer; border:0; font-weight:800;}
  .btn-primary{background:linear-gradient(135deg,var(--accent),#81d4fa); color:#041016;}
  .btn-plain{background:transparent; border:1px solid rgba(255,255,255,0.06); color:var(--muted);}
  .hint{font-size:0.85rem; color:var(--muted); margin-top:8px;}
  .badge{display:inline-block; padding:6px 8px; border-radius:999px; background:rgba(255,255,255,0.03); color:var(--muted); font-weight:700;}
  .success-box{background:linear-gradient(90deg, rgba(61,220,132,0.08), rgba(127,206,255,0.02)); padding:12px; border-radius:8px; color:var(--white); margin-top:12px; text-align:center;}
  .history-item{background:rgba(255,255,255,0.02); padding:10px; border-radius:8px; margin-bottom:8px; border-left: 3px solid var(--accent);}
  .tiny{font-size:0.8rem; color:var(--muted);}
  .hidden { display: none; }
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>üîÅ Seguimiento ‚Äî BlueSphere</h1>
      <p class="lead">Reporta tu progreso. Cada acci√≥n cuenta para el impacto global.</p>

      <div style="margin-bottom:12px;">
        <label>C√≥digo BlueSphere</label>
        <input id="codigoInput" class="input" placeholder="Ej: GPR-AQUA-0021">
        <button id="btnValidar" class="btn btn-plain" style="margin-top:5px; width:100%">üîç Cargar Historial</button>
      </div>

      <div class="flex" style="margin-bottom:12px;">
        <div><span class="badge">Checkins:</span> <span id="numCheckins" class="tiny" style="color:var(--white)">0</span></div>
        <div><span class="badge">Impacto Hoy:</span> <span id="impactoEstimado" class="tiny" style="color:var(--success)">0 kg CO‚ÇÇ</span></div>
      </div>

      <form id="seguimientoForm" class="card" style="margin-top:12px;">
        <div style="margin-bottom:12px;">
          <label>¬øQu√© acciones realizaste este periodo?</label>
          <div class="grid">
            <label><input type="checkbox" class="accion-chk" value="Pl√°stico"> ü•§ Reduje Pl√°sticos</label>
            <label><input type="checkbox" class="accion-chk" value="Transporte"> üö≤ Movilidad Sostenible</label>
            <label><input type="checkbox" class="accion-chk" value="Agua"> üíß Ahorro de Agua</label>
            <label><input type="checkbox" class="accion-chk" value="Consumo"> üå± Consumo Local</label>
            <label><input type="checkbox" class="accion-chk" value="Carne"> ü•© Menos Carne</label>
          </div>
        </div>

        <div style="margin-bottom:12px;">
          <label>Frecuencia</label>
          <select id="frecuencia" class="input">
            <option value="Ocasional">Ocasional</option>
            <option value="Semanal">Semanal</option>
            <option value="Diaria">Diaria</option>
          </select>
        </div>

        <div style="margin-bottom:12px;">
          <label>Comentario / Reflexi√≥n</label>
          <textarea id="comentario" class="input" rows="2" placeholder="Ej: Hoy camin√© al trabajo..."></textarea>
        </div>

        <button id="btnEnviar" class="btn btn-primary" type="button" style="width:100%">üöÄ Registrar Impacto</button>
      </form>

      <div id="resultadoBox" class="hidden">
        <div class="success-box">
            <h3>‚úÖ ¬°Reporte Guardado!</h3>
            <p class="tiny">Tus acciones han sido sumadas al Dashboard Global.</p>
        </div>
      </div>

      <div style="margin-top:25px;">
        <h3 style="color:var(--accent);">üìú Tu Historial</h3>
        <div id="historyBox">
          <div class="tiny">Ingresa tu c√≥digo para ver tu historial.</div>
        </div>
      </div>

    </div>
  </div>

<script>
// 1. CONFIGURACI√ìN SUPABASE
const SB_URL = 'https://ophicpcbgdgzthjamzoz.supabase.co';
const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9waGljcGNiZ2RnenRoamFtem96Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ3MjgwMzUsImV4cCI6MjA4MDMwNDAzNX0.K55Tk-cdbAFDOtGrIMN7vYFaJAccrsD6UdOrARt1P5c';
const supabase = window.supabase.createClient(SB_URL, SB_KEY);

// Factores de Impacto (Simples)
const IMPACTO = { co2: 0.5, agua: 10, plastico: 0.05 }; // por acci√≥n

// 2. INICIALIZAR
document.addEventListener('DOMContentLoaded', async () => {
    // Detectar si venimos del Portal
    const params = new URLSearchParams(window.location.search);
    const codigoURL = params.get('codigo');

    if (codigoURL) {
        document.getElementById('codigoInput').value = codigoURL;
        cargarHistorial(codigoURL);
    }
});

// 3. CARGAR HISTORIAL (Leer Tabla 'seguimiento')
async function cargarHistorial(codigo) {
    const box = document.getElementById('historyBox');
    box.innerHTML = '<div class="tiny">Cargando...</div>';

    const { data, error } = await supabase
        .from('seguimiento')
        .select('*')
        .eq('codigo_guardian', codigo)
        .order('fecha_reporte', { ascending: false });

    if (error) {
        box.innerHTML = '<div class="tiny fail">Error cargando historial.</div>';
        return;
    }

    if (!data || data.length === 0) {
        box.innerHTML = '<div class="tiny">A√∫n no hay reportes. ¬°Env√≠a el primero!</div>';
        document.getElementById('numCheckins').textContent = "0";
        return;
    }

    // Mostrar datos
    document.getElementById('numCheckins').textContent = data.length;
    
    let html = '';
    data.forEach(item => {
        const fecha = new Date(item.fecha_reporte).toLocaleDateString();
        const acciones = item.acciones_realizadas || "Reporte general";
        const co2 = item.impacto_co2 || 0;
        
        html += `
        <div class="history-item">
            <div style="font-weight:bold; color:var(--accent)">${fecha}</div>
            <div class="tiny" style="color:white">${acciones}</div>
            <div class="tiny" style="margin-top:4px;">Impacto: ${co2} kg CO‚ÇÇ</div>
            <div class="tiny" style="font-style:italic; color:gray">"${item.comentario || ''}"</div>
        </div>`;
    });
    box.innerHTML = html;
}

// 4. ENVIAR REPORTE (Escribir en 'seguimiento')
document.getElementById('btnEnviar').addEventListener('click', async () => {
    const codigo = document.getElementById('codigoInput').value.trim();
    if (!codigo) return alert('Falta tu c√≥digo');

    // Recolectar Checkboxes
    let accionesSeleccionadas = [];
    let impactoTotalCO2 = 0;
    
    document.querySelectorAll('.accion-chk:checked').forEach(chk => {
        accionesSeleccionadas.push(chk.value);
        impactoTotalCO2 += IMPACTO.co2; // Sumar impacto por cada acci√≥n
    });

    if (accionesSeleccionadas.length === 0) return alert('Marca al menos una acci√≥n.');

    const frecuencia = document.getElementById('frecuencia').value;
    const comentario = document.getElementById('comentario').value;

    // Enviar a Supabase
    const { error } = await supabase
        .from('seguimiento')
        .insert([{
            codigo_guardian: codigo,
            acciones_realizadas: accionesSeleccionadas.join(', '),
            frecuencia: frecuencia,
            comentario: comentario,
            impacto_co2: impactoTotalCO2,
            impacto_agua: accionesSeleccionadas.length * IMPACTO.agua,
            impacto_plastico: accionesSeleccionadas.length * IMPACTO.plastico
        }]);

    if (error) {
        alert('Error: ' + error.message);
    } else {
        // √âxito visual
        document.getElementById('resultadoBox').style.display = 'block';
        document.getElementById('seguimientoForm').reset();
        document.getElementById('codigoInput').value = codigo; // Mantener c√≥digo
        
        // Recargar historial para ver el nuevo item
        cargarHistorial(codigo);
    }
});

// Bot√≥n manual de carga
document.getElementById('btnValidar').addEventListener('click', () => {
    const c = document.getElementById('codigoInput').value;
    if(c) cargarHistorial(c);
});

// Calculadora visual simple
document.querySelectorAll('.accion-chk').forEach(chk => {
    chk.addEventListener('change', () => {
        const count = document.querySelectorAll('.accion-chk:checked').length;
        document.getElementById('impactoEstimado').textContent = (count * IMPACTO.co2) + ' kg CO‚ÇÇ';
    });
});

</script>
</body>
</html>
