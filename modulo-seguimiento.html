<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>üåç Ritual de Seguimiento Cu√°ntico ‚Äî Sistema Nervioso Planetario BlueSphere</title>
<meta name="description" content="Ceremonia diaria de conexi√≥n con GAIA. Registra tus 18 h√°bitos regenerativos como ofrendas al campo cu√°ntico colectivo." />

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>

<style>
/* ==================== PALETA CEREMONIAL ==================== */
:root {
  --bg: #010912;
  --card: rgba(6, 30, 40, 0.85);
  --glow: #00c4ff;
  --light: #8feaff;
  --muted: #b7e9ff;
  --quantum: #00ffaa;
  --success: #3ddc84;
  --warning: #ffb74d;
}

/* ==================== UNIVERSO VISUAL ==================== */
* { box-sizing: border-box; margin: 0; }
body {
  font-family: 'Inter', system-ui, sans-serif;
  background: radial-gradient(circle at 50% 50%, #061e28 0%, #010912 100%);
  color: #eaffff;
  min-height: 100vh;
  padding: 20px;
  overflow-x: hidden;
}

#particles-js { position: fixed; inset: 0; z-index: 0; pointer-events: none; }

.wrap {
  position: relative; z-index: 2; max-width: 1100px; margin: 0 auto;
  animation: fadeIn 1s ease;
}

@keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

/* ==================== COMPONENTES SAGRADOS ==================== */
.portal-header {
  text-align: center; margin-bottom: 30px; padding: 30px;
  background: rgba(6, 30, 40, 0.6); border-radius: 25px;
  border: 1px solid rgba(0, 196, 255, 0.3);
  backdrop-filter: blur(10px);
  box-shadow: 0 0 50px rgba(0, 196, 255, 0.1);
}

.portal-title {
  font-size: 2.5rem;
  background: linear-gradient(135deg, #fff, var(--glow), var(--quantum));
  -webkit-background-clip: text; background-clip: text; color: transparent;
  text-shadow: 0 0 30px rgba(0, 196, 255, 0.5);
  margin-bottom: 10px; font-weight: 900;
}

.card-ceremonial {
  background: var(--card); border-radius: 25px; padding: 30px;
  border: 1px solid rgba(255, 255, 255, 0.1);
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
  margin-bottom: 25px;
}

/* INPUTS */
.input-ceremonial {
  width: 100%; padding: 15px; border-radius: 12px;
  border: 1px solid rgba(0, 196, 255, 0.3);
  background: rgba(0, 0, 0, 0.3); color: white;
  font-family: monospace; font-size: 1.1rem;
  transition: all 0.3s;
}
.input-ceremonial:focus {
  border-color: var(--quantum); box-shadow: 0 0 20px rgba(0, 255, 170, 0.2); outline: none;
}

/* BOTONES */
.btn-quantum {
  width: 100%; padding: 18px; border-radius: 15px; font-weight: 900;
  background: linear-gradient(135deg, var(--quantum), var(--glow));
  color: #002731; border: none; cursor: pointer;
  box-shadow: 0 0 30px rgba(0, 255, 170, 0.3);
  font-size: 1.2rem; text-transform: uppercase; letter-spacing: 2px;
  transition: transform 0.2s;
}
.btn-quantum:hover { transform: scale(1.02); box-shadow: 0 0 50px rgba(0, 255, 170, 0.5); }

/* GRID DE ACCIONES (ORBES) - AJUSTADO PARA 18 */
.acciones-grid {
  display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 12px;
  margin: 20px 0;
}

.accion-label {
  display: flex; align-items: center; gap: 12px;
  background: rgba(255, 255, 255, 0.05); padding: 12px;
  border-radius: 15px; border: 1px solid rgba(255, 255, 255, 0.1);
  cursor: pointer; transition: all 0.3s; position: relative; overflow: hidden;
}

.accion-label:hover { border-color: var(--glow); background: rgba(0, 196, 255, 0.1); }

.accion-chk { display: none; } /* Ocultar checkbox real */

.accion-chk:checked + .accion-content {
  color: var(--quantum); text-shadow: 0 0 10px var(--quantum);
}
.accion-label:has(.accion-chk:checked) {
  border-color: var(--quantum); background: rgba(0, 255, 170, 0.15);
  box-shadow: 0 0 20px rgba(0, 255, 170, 0.2);
}

.orb-icon { font-size: 1.6rem; min-width: 35px; text-align: center; }

/* MEDALLAS */
.medalla-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 15px; margin-top: 20px; }
.medalla-item {
  background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), transparent);
  border: 1px solid rgba(255, 215, 0, 0.3); padding: 15px; border-radius: 15px;
  text-align: center; animation: float 4s ease-in-out infinite;
}
@keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }

/* LOADER & RESULTADOS */
.loader-box { display: none; text-align: center; padding: 20px; }
.spinner {
  width: 50px; height: 50px; border: 5px solid rgba(0, 255, 170, 0.3);
  border-top-color: var(--quantum); border-radius: 50%;
  animation: spin 1s linear infinite; margin: 0 auto;
}
@keyframes spin { to { transform: rotate(360deg); } }

.success-message {
  display: none; background: rgba(61, 220, 132, 0.1); border: 1px solid var(--success);
  padding: 20px; border-radius: 15px; text-align: center; margin-top: 20px;
  animation: fadeIn 0.5s;
}

.hidden { display: none; }
</style>
</head>
<body>

<div id="particles-js"></div>

<div class="wrap">
  
  <header class="portal-header">
    <h1 class="portal-title">üåç RITUAL DE SEGUIMIENTO</h1>
    <p style="color: var(--muted); letter-spacing: 3px; font-size: 0.9rem;">SISTEMA NERVIOSO PLANETARIO ACTIVO</p>
  </header>

  <div class="card-ceremonial">
    
    <div style="margin-bottom: 30px;">
      <label style="color: var(--glow); font-weight: bold; margin-bottom: 10px; display: block;">üîÆ C√ìDIGO DE GUARDI√ÅN</label>
      <input id="codigoInput" class="input-ceremonial" placeholder="GPR-AQUA-ZIRIUX-..." readonly>
      <div id="statusCodigo" style="margin-top: 10px; font-size: 0.9rem; color: var(--muted);">
        üåÄ Esperando sincronizaci√≥n...
      </div>
    </div>

    <h3 style="color: var(--light); border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; margin-bottom: 20px;">
      üåø OFRENDAS DEL D√çA (LOS 18 H√ÅBITOS)
    </h3>

    <div class="acciones-grid">
      
      <label class="accion-label">
        <input type="checkbox" class="accion-chk" value="menos_plastico">
        <div class="orb-icon">ü•§</div>
        <div class="accion-content">
          <strong>Reducci√≥n Pl√°sticos</strong><br><span style="font-size:0.75rem; opacity:0.7;">Chakra Ra√≠z</span>
        </div>
      </label>

      <label class="accion-label">
        <input type="checkbox" class="accion-chk" value="transporte_limpio">
        <div class="orb-icon">üö≤</div>
        <div class="accion-content">
          <strong>Transporte Sagrado</strong><br><span style="font-size:0.75rem; opacity:0.7;">Chakra Ra√≠z</span>
        </div>
      </label>

      <label class="accion-label">
        <input type="checkbox" class="accion-chk" value="reciclaje">
        <div class="orb-icon">‚ôªÔ∏è</div>
        <div class="accion-content">
          <strong>Alquimia Residuos</strong><br><span style="font-size:0.75rem; opacity:0.7;">Chakra Ra√≠z</span>
        </div>
      </label>

      <label class="accion-label">
        <input type="checkbox" class="accion-chk" value="limpieza_natural">
        <div class="orb-icon">üèñÔ∏è</div>
        <div class="accion-content">
          <strong>Sanaci√≥n Espacios</strong><br><span style="font-size:0.75rem; opacity:0.7;">Chakra Ra√≠z</span>
        </div>
      </label>
      
      <label class="accion-label">
        <input type="checkbox" class="accion-chk" value="reparar_objetos">
        <div class="orb-icon">üß©</div>
        <div class="accion-content">
          <strong>Kintsugi / Reparar</strong><br><span style="font-size:0.75rem; opacity:0.7;">Chakra Ra√≠z</span>
        </div>
      </label>

      <label class="accion-label">
        <input type="checkbox" class="accion-chk" value="ahorro_agua">
        <div class="orb-icon">üíß</div>
        <div class="accion-content">
          <strong>Bendici√≥n del Agua</strong><br><span style="font-size:0.75rem; opacity:0.7;">Chakra Sacro</span>
        </div>
      </label>

      <label class="accion-label">
        <input type="checkbox" class="accion-chk" value="sin_desperdicio">
        <div class="orb-icon">ü•ó</div>
        <div class="accion-content">
          <strong>Eucarist√≠a Alimentaria</strong><br><span style="font-size:0.75rem; opacity:0.7;">Chakra Sacro</span>
        </div>
      </label>
      
      <label class="accion-label">
        <input type="checkbox" class="accion-chk" value="cosmetica_natural">
        <div class="orb-icon">üß¥</div>
        <div class="accion-content">
          <strong>Ung√ºentos Naturales</strong><br><span style="font-size:0.75rem; opacity:0.7;">Chakra Sacro</span>
        </div>
      </label>

      <label class="accion-label">
        <input type="checkbox" class="accion-chk" value="energia_ahorro">
        <div class="orb-icon">üîã</div>
        <div class="accion-content">
          <strong>Meditaci√≥n Energ√©tica</strong><br><span style="font-size:0.75rem; opacity:0.7;">Chakra Plexo</span>
        </div>
      </label>

      <label class="accion-label">
        <input type="checkbox" class="accion-chk" value="consumo_local">
        <div class="orb-icon">üõí</div>
        <div class="accion-content">
          <strong>Compra Voto Sagrado</strong><br><span style="font-size:0.75rem; opacity:0.7;">Chakra Plexo</span>
        </div>
      </label>

      <label class="accion-label">
        <input type="checkbox" class="accion-chk" value="reforestacion">
        <div class="orb-icon">üå≥</div>
        <div class="accion-content">
          <strong>Plantaci√≥n Ceremonial</strong><br><span style="font-size:0.75rem; opacity:0.7;">Chakra Coraz√≥n</span>
        </div>
      </label>

      <label class="accion-label">
        <input type="checkbox" class="accion-chk" value="dia_sin_carne">
        <div class="orb-icon">üåø</div>
        <div class="accion-content">
          <strong>Ayuno de Compasi√≥n</strong><br><span style="font-size:0.75rem; opacity:0.7;">Chakra Coraz√≥n</span>
        </div>
      </label>
      
      <label class="accion-label">
        <input type="checkbox" class="accion-chk" value="polinizadores">
        <div class="orb-icon">üêù</div>
        <div class="accion-content">
          <strong>Santuario Abejas</strong><br><span style="font-size:0.75rem; opacity:0.7;">Chakra Coraz√≥n</span>
        </div>
      </label>
      
      <label class="accion-label">
        <input type="checkbox" class="accion-chk" value="comercio_justo">
        <div class="orb-icon">ü§ù</div>
        <div class="accion-content">
          <strong>Comercio Justo</strong><br><span style="font-size:0.75rem; opacity:0.7;">Chakra Coraz√≥n</span>
        </div>
      </label>

      <label class="accion-label">
        <input type="checkbox" class="accion-chk" value="activismo_digital">
        <div class="orb-icon">üì¢</div>
        <div class="accion-content">
          <strong>Evangelio Digital</strong><br><span style="font-size:0.75rem; opacity:0.7;">Chakra Garganta</span>
        </div>
      </label>

      <label class="accion-label">
        <input type="checkbox" class="accion-chk" value="digital_limpio">
        <div class="orb-icon">üìµ</div>
        <div class="accion-content">
          <strong>Silencio Digital</strong><br><span style="font-size:0.75rem; opacity:0.7;">Tercer Ojo</span>
        </div>
      </label>
      
       <label class="accion-label">
        <input type="checkbox" class="accion-chk" value="formacion_ambiental">
        <div class="orb-icon">üìö</div>
        <div class="accion-content">
          <strong>Transmisi√≥n Sabidur√≠a</strong><br><span style="font-size:0.75rem; opacity:0.7;">Tercer Ojo</span>
        </div>
      </label>

      <label class="accion-label">
        <input type="checkbox" class="accion-chk" value="voluntariado">
        <div class="orb-icon">üôå</div>
        <div class="accion-content">
          <strong>Servicio Sagrado</strong><br><span style="font-size:0.75rem; opacity:0.7;">Chakra Corona</span>
        </div>
      </label>

    </div>

    <div style="margin: 20px 0;">
      <label style="display:block; margin-bottom:10px; color:var(--muted);">üìú REFLEXI√ìN O COMENTARIO</label>
      <textarea id="comentarioInput" class="input-ceremonial" rows="2" placeholder="Tu mensaje para el campo cu√°ntico..."></textarea>
    </div>

    <div style="background: rgba(0, 255, 170, 0.1); padding: 15px; border-radius: 12px; text-align: center; margin-bottom: 20px; border: 1px solid var(--quantum);">
      IMPACTO ESTIMADO: <strong id="impactoDisplay" style="font-size: 1.2rem; color: var(--quantum);">0.0</strong> kg CO‚ÇÇ
    </div>

    <button id="btnRegistrar" class="btn-quantum">
      ‚ö° ENVIAR PULSO A GAIA
    </button>

    <div id="loader" class="loader-box">
      <div class="spinner"></div>
      <p style="margin-top: 10px; color: var(--quantum);">Sincronizando con Supabase...</p>
    </div>

  <div id="successMsg" class="success-message">
      <h3 style="color: var(--success);">‚úÖ OFRENDA RECIBIDA</h3>
      <p>Tu impacto ha sido grabado en el n√∫cleo de BlueSphere.</p>
      
      <div style="margin-top: 20px;">
    <a href="dashboard-global-impacto.html" id="btnDashboard" 
       style="display:none; background: linear-gradient(135deg, #00c4ff, #005c84); color:white; padding:12px 25px; border-radius:30px; text-decoration:none; font-weight:bold; box-shadow: 0 0 20px rgba(0,196,255,0.4); border: 1px solid #00ffaa;">
        üìä Mirar el Dashboard
    </a>
</div>

  </div>

  <div id="seccionMedallas" class="card-ceremonial hidden">
    <h3 style="color: #FFD700; text-align: center;">üèÜ TUS MEDALLAS SAGRADAS</h3>
    <div id="gridMedallas" class="medalla-grid">
      </div>
  </div>

</div>

<script>
  // 1. CONFIGURACI√ìN SUPABASE (TUS CREDENCIALES REALES)
  const SUPABASE_URL = 'https://ophicpcbgdgzthjamzoz.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9waGljcGNiZ2RnenRoamFtem96Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ3MjgwMzUsImV4cCI6MjA4MDMwNDAzNX0.K55Tk-cdbAFDOtGrIMN7vYFaJAccrsD6UdOrARt1P5c';
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  // 2. PARTICULAS
  particlesJS("particles-js", {
    "particles": { "number": { "value": 80 }, "color": { "value": "#00ffaa" }, "opacity": { "value": 0.3 }, "size": { "value": 3 }, "line_linked": { "enable": true, "color": "#00c4ff", "opacity": 0.2 } }
  });

  // 3. VARIABLES
  const codigoInput = document.getElementById('codigoInput');
  const statusCodigo = document.getElementById('statusCodigo');
  const btnRegistrar = document.getElementById('btnRegistrar');
  const checkboxes = document.querySelectorAll('.accion-chk');
  const impactoDisplay = document.getElementById('impactoDisplay');
  let impactoTotal = 0;

  // 4. INICIALIZACI√ìN (DETECTAR Y ESCUCHAR C√ìDIGO)
  window.onload = async () => {
    const params = new URLSearchParams(window.location.search);
    const codigoURL = params.get('codigo');

    if(codigoURL) {
      codigoInput.value = codigoURL;
      statusCodigo.innerHTML = `<span style="color:#3ddc84">‚úÖ Sincronizado con Portal Azul</span>`;
      cargarMedallas(codigoURL);
    } else {
      statusCodigo.innerHTML = `<span style="color:#ffb74d">‚ö†Ô∏è Modo Manual (Ingresa tu c√≥digo)</span>`;
      codigoInput.removeAttribute('readonly');
    }
  };

  // 4.1 ESCUCHADOR DE ENTRADA MANUAL (EL PARCHE)
  codigoInput.addEventListener('input', () => {
    const valor = codigoInput.value.trim();
    if(valor.length >= 10) {
      statusCodigo.innerHTML = `<span style="color:#3ddc84">‚úÖ C√≥digo Detectado (Validando...)</span>`;
      cargarMedallas(valor); // Esto recupera tus medallas autom√°ticamente
    } else {
      statusCodigo.innerHTML = `<span style="color:#ffb74d">‚ö†Ô∏è Modo Manual (Ingresa tu c√≥digo)</span>`;
    }
  });

  // 5. CALCULAR IMPACTO EN TIEMPO REAL
  checkboxes.forEach(chk => {
    chk.addEventListener('change', () => {
      let impacto = 0;
      checkboxes.forEach(c => {
        if(c.checked) {
          const val = c.value;
          // Impacto ponderado seg√∫n el tipo de acci√≥n
          if(val === 'reforestacion' || val === 'voluntariado' || val === 'limpieza_natural') impacto += 5.0;
          else if(val === 'transporte_limpio' || val === 'dia_sin_carne' || val === 'reparar_objetos') impacto += 2.5;
          else if(val === 'activismo_digital' || val === 'digital_limpio') impacto += 0.5;
          else impacto += 1.0;
        }
      });
      impactoTotal = impacto;
      impactoDisplay.textContent = impacto.toFixed(1);
    });
  });

  // 6. REGISTRAR EN SUPABASE
  btnRegistrar.addEventListener('click', async () => {
    const codigo = codigoInput.value.trim();
    if(!codigo || codigo.length < 10) {
      alert("‚ö†Ô∏è Error: C√≥digo de Guardi√°n inv√°lido o no detectado.");
      return;
    }

    if(impactoTotal === 0) {
      alert("‚ö†Ô∏è Selecciona al menos una ofrenda (acci√≥n) para registrar.");
      return;
    }

    // Preparar datos
    const acciones = Array.from(checkboxes).filter(c => c.checked).map(c => c.value).join(', ');
    const comentario = document.getElementById('comentarioInput').value;

    // UI Loading
    document.getElementById('loader').style.display = 'block';
    btnRegistrar.style.display = 'none';

    try {
      const { error } = await supabase
        .from('seguimiento')
        .insert([{
          codigo_guardian: codigo,
          acciones_realizadas: acciones,
          impacto_co2: impactoTotal,
          comentario: comentario,
          fecha_reporte: new Date().toISOString()
        }]);

      if(error) throw error;

      // √âxito: La ofrenda ha cruzado el umbral hacia GAIA
      document.getElementById('loader').style.display = 'none';
      document.getElementById('successMsg').style.display = 'block';

      // RECONEXI√ìN CON EL NEXO DE IMPACTO GLOBAL
      const btnDashboard = document.getElementById('btnDashboard');
      if(btnDashboard) {
          // El bot√≥n se vuelve visible para el Guardi√°n
          btnDashboard.style.display = 'inline-block'; 
          // Confirmaci√≥n en consola para el Comandante
          console.log("Portal al Dashboard Global activo."); 
      }
      
      // Recargar medallas para ver si gan√≥ alguna nueva
      cargarMedallas(codigo);
      
      // Resetear checkboxes
      checkboxes.forEach(c => c.checked = false);
      impactoDisplay.textContent = "0.0";

    } catch (err) {
      console.error(err);
      alert("Error de conexi√≥n con GAIA: " + err.message);
      document.getElementById('loader').style.display = 'none';
      btnRegistrar.style.display = 'block';
    }
  });

  // 7. CARGAR MEDALLAS (Sistema Simplificado)
  async function cargarMedallas(codigo) {
    const { data, error } = await supabase
      .from('seguimiento')
      .select('*')
      .eq('codigo_guardian', codigo);

    if(data && data.length > 0) {
      document.getElementById('seccionMedallas').classList.remove('hidden');
      const grid = document.getElementById('gridMedallas');
      let html = '';
      
      // L√≥gica simple de medallas basada en cantidad de registros
      if(data.length >= 1) html += `<div class="medalla-item"><div style="font-size:2rem">üå±</div><div style="font-weight:bold; color:#FFD700">Primer Paso</div></div>`;
      if(data.length >= 5) html += `<div class="medalla-item"><div style="font-size:2rem">üî•</div><div style="font-weight:bold; color:#FFD700">Constancia</div></div>`;
      if(data.length >= 15) html += `<div class="medalla-item"><div style="font-size:2rem">üõ°Ô∏è</div><div style="font-weight:bold; color:#FFD700">Guardi√°n</div></div>`;
      if(data.length >= 30) html += `<div class="medalla-item"><div style="font-size:2rem">‚≠ê</div><div style="font-weight:bold; color:#FFD700">Maestro Azul</div></div>`;
      
      // Calcular impacto total acumulado
      const impactoAcumulado = data.reduce((sum, item) => sum + (item.impacto_co2 || 0), 0);
      if(impactoAcumulado > 50) html += `<div class="medalla-item"><div style="font-size:2rem">üíé</div><div style="font-weight:bold; color:#FFD700">Impacto Alto</div></div>`;

      grid.innerHTML = html;
    }
  }

</script>
</body>
</html>
