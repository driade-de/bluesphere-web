<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Seguimiento BlueSphere</title>
<!-- SUPABASE DESDE CDN OFICIAL -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
<style>
  :root{ --bg:#041016; --card:#07212a; --accent:#4fc3f7; --muted:#c8eaff; --success:#3ddc84; --white:#ffffff; }
  body{font-family:Inter, sans-serif; background:var(--bg); color:var(--white); margin:0; padding:20px;}
  .wrap{max-width:800px; margin:20px auto;}
  .card{background:var(--card); border-radius:12px; padding:25px; border:1px solid rgba(127,206,255,0.1);}
  
  h1{color:var(--accent); margin:0 0 10px; font-size:2rem; text-align:center;}
  p.lead{color:var(--muted); text-align:center; margin-bottom:30px;}

  .input, textarea, select{width:100%; padding:12px; border-radius:8px; border:1px solid #19434d; background:#021219; color:var(--white); box-sizing:border-box; margin-bottom:15px;}
  label{display:block; color:var(--muted); margin-bottom:8px; font-weight:bold;}
  
  .btn{padding:12px 20px; border-radius:8px; cursor:pointer; border:0; font-weight:bold; width:100%; font-size:1rem;}
  .btn-primary{background:linear-gradient(135deg,var(--accent),#81d4fa); color:#041016;}
  .btn-plain{background:transparent; border:1px solid rgba(255,255,255,0.2); color:var(--muted); margin-top:10px;}
  
  .history-item{background:rgba(255,255,255,0.03); padding:15px; border-radius:8px; margin-bottom:10px; border-left: 3px solid var(--success);}
  .tiny{font-size:0.85rem; color:var(--muted);}
  .hidden { display: none !important; }
  
  /* NUEVOS ESTILOS PARA +17 ACCIONES */
  .acciones-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 12px;
    margin-bottom: 20px;
  }
  
  .accion-option {
    display: flex;
    align-items: center;
    padding: 12px;
    background: rgba(255,255,255,0.05);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
    border: 1px solid rgba(255,255,255,0.1);
  }
  
  .accion-option:hover {
    background: rgba(79, 195, 247, 0.15);
    transform: translateY(-2px);
  }
  
  .accion-option input {
    margin-right: 10px;
    transform: scale(1.2);
  }
  
  .section-title {
    color: var(--accent);
    margin: 25px 0 15px 0;
    font-size: 1.2rem;
    padding-bottom: 8px;
    border-bottom: 2px solid rgba(79, 195, 247, 0.3);
  }
  
  .stats-bar {
    background: rgba(255,255,255,0.05);
    padding: 15px;
    border-radius: 10px;
    margin: 20px 0;
    text-align: center;
    border: 1px solid rgba(79, 195, 247, 0.2);
  }
  
  .stats-bar strong {
    color: var(--accent);
    font-size: 1.3rem;
  }
  
  .loader {
    border: 3px solid rgba(255,255,255,0.1);
    border-top: 3px solid var(--accent);
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin: 20px auto;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
</style>
</head>
<body>

<div class="wrap">
  <div class="card">
    
    <h1>ğŸ“Š Seguimiento</h1>
    <p class="lead">Reporte de actividad del GuardiÃ¡n</p>

    <label>Tu CÃ³digo de GuardiÃ¡n</label>
    <input id="codigoInput" class="input" placeholder="Ej: GPR-AQUA-0021" value="GPR-AQUA-0059">
    <button class="btn btn-plain" onclick="validarYBuscar()">ğŸ” Cargar mi Historial</button>

    <form id="seguimientoForm" style="margin-top:20px;">
      
      <!-- SECCIÃ“N 1: ACCIONES BÃSICAS -->
      <div class="section-title">ğŸš€ Acciones Diarias / BÃ¡sicas</div>
      <div class="acciones-grid">
        <label class="accion-option">
          <input type="checkbox" class="accion-chk" value="Menos plÃ¡stico"> ğŸ¥¤ Menos plÃ¡stico
        </label>
        <label class="accion-option">
          <input type="checkbox" class="accion-chk" value="Transporte limpio"> ğŸš² Transporte limpio
        </label>
        <label class="accion-option">
          <input type="checkbox" class="accion-chk" value="Ahorro agua"> ğŸ’§ Ahorro agua
        </label>
        <label class="accion-option">
          <input type="checkbox" class="accion-chk" value="Consumo local"> ğŸŒ± Consumo local
        </label>
        <label class="accion-option">
          <input type="checkbox" class="accion-chk" value="Reciclaje correcto"> â™»ï¸ Reciclaje
        </label>
        <label class="accion-option">
          <input type="checkbox" class="accion-chk" value="Digital sostenible"> ğŸ“µ Digital sostenible
        </label>
        <label class="accion-option">
          <input type="checkbox" class="accion-chk" value="Comida sin desperdicio"> ğŸƒ Sin desperdicio
        </label>
        <label class="accion-option">
          <input type="checkbox" class="accion-chk" value="EnergÃ­a ahorrada"> ğŸ”‹ EnergÃ­a ahorrada
        </label>
      </div>
      
      <!-- SECCIÃ“N 2: ACCIONES AVANZADAS -->
      <div class="section-title">ğŸŒŸ Acciones de Alto Impacto</div>
      <div class="acciones-grid">
        <label class="accion-option">
          <input type="checkbox" class="accion-chk" value="Limpieza playa/rÃ­o"> ğŸ–ï¸ Limpieza natural
        </label>
        <label class="accion-option">
          <input type="checkbox" class="accion-chk" value="Compra consciente"> ğŸ›’ Compra consciente
        </label>
        <label class="accion-option">
          <input type="checkbox" class="accion-chk" value="DÃ­a sin carne"> ğŸŒ¿ DÃ­a sin carne
        </label>
        <label class="accion-option">
          <input type="checkbox" class="accion-chk" value="Activismo digital"> ğŸ“¢ Activismo digital
        </label>
        <label class="accion-option">
          <input type="checkbox" class="accion-chk" value="ReforestaciÃ³n"> ğŸŒ³ ReforestaciÃ³n
        </label>
        <label class="accion-option">
          <input type="checkbox" class="accion-chk" value="Productos ecolÃ³gicos"> ğŸ§´ Productos ecolÃ³gicos
        </label>
        <label class="accion-option">
          <input type="checkbox" class="accion-chk" value="Voluntariado ambiental"> ğŸ¤ Voluntariado
        </label>
        <label class="accion-option">
          <input type="checkbox" class="accion-chk" value="Reparar objetos"> ğŸ§© Reparar objetos
        </label>
        <label class="accion-option">
          <input type="checkbox" class="accion-chk" value="FormaciÃ³n ambiental"> ğŸ“š FormaciÃ³n ambiental
        </label>
        <label class="accion-option">
          <input type="checkbox" class="accion-chk" value="JardÃ­n polinizadores"> ğŸ JardÃ­n polinizadores
        </label>
      </div>

      <label>Frecuencia</label>
      <select id="frecuencia" class="input">
        <option value="Semanal">Semanal</option>
        <option value="Diaria">Diaria</option>
        <option value="Ocasional">Ocasional</option>
        <option value="Primera vez">Primera vez</option>
      </select>

      <label>Comentario o reflexiÃ³n</label>
      <textarea id="comentario" class="input" rows="3" placeholder="Â¿CuÃ¡l fue tu acciÃ³n mÃ¡s significativa? Â¿QuÃ© aprendiste?"></textarea>

      <label>Impacto estimado (kg COâ‚‚ evitados)</label>
      <input type="number" id="impactoCo2" class="input" placeholder="Ej: 2.5" step="0.1" min="0">

      <button id="btnEnviar" class="btn btn-primary" type="button" onclick="enviarReporte()">ğŸš€ Registrar Impacto</button>
    </form>

    <div id="mensajeBox" style="margin-top:20px; text-align:center; padding:15px; border-radius:8px;" class="hidden"></div>
    
    <div id="loaderBox" class="hidden">
      <div class="loader"></div>
      <p style="text-align:center; color:var(--muted); margin-top:10px;">Procesando...</p>
    </div>

    <div id="historyBox" class="hidden" style="margin-top:30px; border-top:1px solid rgba(255,255,255,0.1); padding-top:20px;">
      <h3 style="color:var(--accent); text-align:center;">ğŸ“Š Tu Historial de Impacto</h3>
      <div id="statsBar" class="stats-bar hidden">
        <span>ğŸŒ Impacto total acumulado: <strong id="totalImpacto">0</strong> kg COâ‚‚ evitados</span>
      </div>
      <div id="listaHistorial"></div>
    </div>

    <div style="margin-top:30px; text-align:center; color:var(--muted); font-size:0.9rem; border-top:1px solid rgba(255,255,255,0.1); padding-top:15px;">
      ğŸ”— <strong>Conectado a Dashboard Global BlueSphere</strong><br>
      Tus acciones se suman automÃ¡ticamente al impacto colectivo.
    </div>

  </div>
</div>

<!-- ==================== JAVASCRIPT COMPLETO ==================== -->
<script>
// ================= CONFIGURACIÃ“N SUPABASE =================
const SUPABASE_URL = 'https://ophicpcbgdgzthjamzoz.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9waGljcGNiZ2RnenRoamFtem96Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ3MjgwMzUsImV4cCI6MjA4MDMwNDAzNX0.K55Tk-cdbAFDOtGrIMN7vYFaJAccrsD6UdOrARt1P5c';

// Inicializar Supabase (mÃ©todo seguro)
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// ================= FUNCIONES PRINCIPALES =================
async function validarYBuscar() {
  const codigo = document.getElementById('codigoInput').value.trim();
  if (!codigo) {
    mostrarMensaje("âš ï¸ Escribe un cÃ³digo primero", "#ffb74d");
    return;
  }
  
  mostrarLoader(true);
  await cargarHistorial(codigo);
  mostrarLoader(false);
}

async function enviarReporte() {
  const codigo = document.getElementById('codigoInput').value.trim();
  if (!codigo) {
    mostrarMensaje("âš ï¸ Falta el cÃ³digo de guardiÃ¡n", "#ffb74d");
    return;
  }

  // Recoger acciones seleccionadas
  let acciones = [];
  document.querySelectorAll('.accion-chk:checked').forEach(c => acciones.push(c.value));
  
  if (acciones.length === 0) {
    mostrarMensaje("âš ï¸ Selecciona al menos una acciÃ³n", "#ffb74d");
    return;
  }

  const frecuencia = document.getElementById('frecuencia').value;
  const comentario = document.getElementById('comentario').value;
  const impactoCo2 = document.getElementById('impactoCo2').value || (acciones.length * 0.8);

  mostrarLoader(true);
  mostrarMensaje("ğŸ“¤ Enviando reporte...", "#81d4fa");

  try {
    // Guardar en Supabase
    const { error } = await supabase
      .from('seguimiento')
      .insert([{
        codigo_guardian: codigo,
        acciones_realizadas: acciones.join(', '),
        frecuencia: frecuencia,
        comentario: comentario,
        impacto_co2: parseFloat(impactoCo2),
        fecha_reporte: new Date().toISOString()
      }]);

    if (error) throw error;

    // Ã‰xito
    mostrarMensaje('âœ… Reporte guardado con Ã©xito. Â¡Gracias por tu impacto!', '#3ddc84');
    
    // Limpiar formulario
    document.querySelectorAll('.accion-chk').forEach(cb => cb.checked = false);
    document.getElementById('comentario').value = '';
    document.getElementById('impactoCo2').value = '';
    
    // Recargar historial
    await cargarHistorial(codigo);
    
  } catch (error) {
    console.error('Error:', error);
    mostrarMensaje('âŒ Error: ' + error.message, '#ff7b7b');
  } finally {
    mostrarLoader(false);
  }
}

async function cargarHistorial(codigo) {
  try {
    const { data, error } = await supabase
      .from('seguimiento')
      .select('*')
      .eq('codigo_guardian', codigo)
      .order('fecha_reporte', { ascending: false });

    const lista = document.getElementById('listaHistorial');
    const caja = document.getElementById('historyBox');
    const statsBar = document.getElementById('statsBar');
    
    if (error) throw error;

    if (data && data.length > 0) {
      caja.classList.remove('hidden');
      statsBar.classList.remove('hidden');
      
      // Calcular total de impacto
      const totalImpacto = data.reduce((sum, item) => sum + (item.impacto_co2 || 0), 0);
      document.getElementById('totalImpacto').textContent = totalImpacto.toFixed(2);
      
      // Mostrar historial
      lista.innerHTML = data.map(item => `
        <div class="history-item">
          <div style="font-weight:bold; color:var(--accent)">
            ${new Date(item.fecha_reporte).toLocaleDateString('es-ES', { 
              weekday: 'short', 
              year: 'numeric', 
              month: 'short', 
              day: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
            })}
          </div>
          <div style="margin:8px 0;">${item.acciones_realizadas}</div>
          <div style="color:#81d4fa; font-size:0.9rem; margin:5px 0;">
            ğŸŒ¿ ${item.impacto_co2 ? item.impacto_co2 + ' kg COâ‚‚ evitados' : 'Impacto registrado'}
          </div>
          ${item.comentario ? `<div class="tiny">"${item.comentario}"</div>` : ''}
        </div>
      `).join('');
      
    } else {
      caja.classList.remove('hidden');
      statsBar.classList.add('hidden');
      lista.innerHTML = '<div class="tiny" style="text-align:center; padding:20px;">No hay reportes previos. SÃ© el primero en registrar tu impacto.</div>';
    }
    
  } catch (error) {
    console.error('Error cargando historial:', error);
    mostrarMensaje('âš ï¸ Error al cargar historial', '#ff7b7b');
  }
}

// ================= UTILIDADES =================
function mostrarMensaje(texto, color) {
  const box = document.getElementById('mensajeBox');
  box.textContent = texto;
  box.style.color = color;
  box.style.border = `1px solid ${color}`;
  box.style.background = color === '#3ddc84' ? 'rgba(61,220,132,0.1)' : 
                         color === '#ffb74d' ? 'rgba(255,183,77,0.1)' : 
                         color === '#81d4fa' ? 'rgba(129,212,250,0.1)' : 
                         'rgba(255,123,123,0.1)';
  box.classList.remove('hidden');
  setTimeout(() => box.classList.add('hidden'), 5000);
}

function mostrarLoader(mostrar) {
  const loader = document.getElementById('loaderBox');
  if (mostrar) {
    loader.classList.remove('hidden');
  } else {
    loader.classList.add('hidden');
  }
}

// ================= INICIALIZACIÃ“N =================
document.addEventListener('DOMContentLoaded', function() {
  console.log('Seguimiento BlueSphere - Inicializado');
  
  // Auto-cargar si hay cÃ³digo en URL
  const params = new URLSearchParams(window.location.search);
  const codigoURL = params.get('codigo');
  if (codigoURL) {
    document.getElementById('codigoInput').value = codigoURL;
    setTimeout(() => {
      validarYBuscar();
    }, 800);
  }
  
  // Calcular impacto automÃ¡tico basado en acciones seleccionadas
  document.querySelectorAll('.accion-chk').forEach(checkbox => {
    checkbox.addEventListener('change', function() {
      const checked = document.querySelectorAll('.accion-chk:checked');
      let impactoTotal = 0;
      
      checked.forEach(cb => {
        const valor = cb.value;
        // Acciones avanzadas valen mÃ¡s
        if (valor.includes('Limpieza') || valor.includes('ReforestaciÃ³n') || 
            valor.includes('Voluntariado') || valor.includes('Activismo')) {
          impactoTotal += 1.5;
        } else if (valor.includes('Compra') || valor.includes('Productos') || 
                   valor.includes('FormaciÃ³n')) {
          impactoTotal += 1.0;
        } else {
          impactoTotal += 0.5;
        }
      });
      
      document.getElementById('impactoCo2').value = impactoTotal.toFixed(1);
    });
  });
});

// ================= EXPORTAR FUNCIONES AL GLOBAL =================
window.validarYBuscar = validarYBuscar;
window.enviarReporte = enviarReporte;
</script>
<!-- ==================== FIN JAVASCRIPT ==================== -->

</body>
</html>
