<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Seguimiento</title>
<style>
  :root{ --bg:#041016; --card:#07212a; --accent:#4fc3f7; --muted:#c8eaff; --success:#3ddc84; --white:#ffffff; }
  body{font-family:Inter, sans-serif; background:var(--bg); color:var(--white); margin:0; padding:20px;}
  .wrap{max-width:800px; margin:20px auto;}
  .card{background:var(--card); border-radius:12px; padding:25px; border:1px solid rgba(127,206,255,0.1);}
  
  h1{color:var(--accent); margin:0 0 10px; font-size:2rem; text-align:center;}
  p.lead{color:var(--muted); text-align:center; margin-bottom:30px;}

  .input, textarea, select{width:100%; padding:12px; border-radius:8px; border:1px solid #19434d; background:#021219; color:var(--white); box-sizing:border-box; margin-bottom:15px;}
  label{display:block; color:var(--muted); margin-bottom:8px; font-weight:bold;}
  
  .btn{padding:12px 20px; border-radius:8px; cursor:pointer; border:0; font-weight:bold; width:100%; font-size:1rem;}
  .btn-primary{background:linear-gradient(135deg,var(--accent),#81d4fa); color:#041016;}
  .btn-plain{background:transparent; border:1px solid rgba(255,255,255,0.2); color:var(--muted); margin-top:10px;}
  
  .history-item{background:rgba(255,255,255,0.03); padding:15px; border-radius:8px; margin-bottom:10px; border-left: 3px solid var(--success);}
  .tiny{font-size:0.85rem; color:var(--muted);}
  .hidden { display: none !important; }
  
  /* Nuevos estilos para mÃ¡s opciones */
  .acciones-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 10px;
    margin-bottom: 15px;
  }
  
  .accion-option {
    display: flex;
    align-items: center;
    padding: 8px 10px;
    background: rgba(255,255,255,0.05);
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
  }
  
  .accion-option:hover {
    background: rgba(79, 195, 247, 0.1);
  }
  
  .accion-option input {
    margin-right: 8px;
  }
  
  .section-title {
    color: var(--accent);
    margin: 20px 0 10px 0;
    font-size: 1.1rem;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    padding-bottom: 5px;
  }
</style>
</head>
<body>

  <div class="wrap">
    <div class="card">
      
      <h1>Seguimiento</h1>
      <p class="lead">Reporte de actividad del GuardiÃ¡n</p>

      <label>Tu CÃ³digo de GuardiÃ¡n</label>
      <input id="codigoInput" class="input" placeholder="Ej: GPR-AQUA-0021">
      <button class="btn btn-plain" onclick="validarYBuscar()">ğŸ” Cargar mi Historial</button>

      <form id="seguimientoForm" style="margin-top:20px;">
        
        <div class="section-title">ğŸš€ Acciones Diarias / BÃ¡sicas</div>
        <div class="acciones-grid">
          <label class="accion-option">
            <input type="checkbox" class="accion-chk" value="Menos plÃ¡stico"> ğŸ¥¤ Menos plÃ¡stico
          </label>
          <label class="accion-option">
            <input type="checkbox" class="accion-chk" value="Transporte limpio"> ğŸš² Transporte limpio
          </label>
          <label class="accion-option">
            <input type="checkbox" class="accion-chk" value="Ahorro agua"> ğŸ’§ Ahorro agua
          </label>
          <label class="accion-option">
            <input type="checkbox" class="accion-chk" value="Consumo local"> ğŸŒ± Consumo local
          </label>
          <label class="accion-option">
            <input type="checkbox" class="accion-chk" value="Reciclaje correcto"> â™»ï¸ Reciclaje
          </label>
          <label class="accion-option">
            <input type="checkbox" class="accion-chk" value="Digital sostenible"> ğŸ“µ Digital sostenible
          </label>
          <label class="accion-option">
            <input type="checkbox" class="accion-chk" value="Comida sin desperdicio"> ğŸƒ Sin desperdicio
          </label>
          <label class="accion-option">
            <input type="checkbox" class="accion-chk" value="EnergÃ­a ahorrada"> ğŸ”‹ EnergÃ­a ahorrada
          </label>
        </div>
        
        <div class="section-title">ğŸŒŸ Acciones de Alto Impacto</div>
        <div class="acciones-grid">
          <label class="accion-option">
            <input type="checkbox" class="accion-chk" value="Limpieza playa/rÃ­o"> ğŸ–ï¸ Limpieza natural
          </label>
          <label class="accion-option">
            <input type="checkbox" class="accion-chk" value="Compra consciente"> ğŸ›’ Compra consciente
          </label>
          <label class="accion-option">
            <input type="checkbox" class="accion-chk" value="DÃ­a sin carne"> ğŸŒ¿ DÃ­a sin carne
          </label>
          <label class="accion-option">
            <input type="checkbox" class="accion-chk" value="Activismo digital"> ğŸ“¢ Activismo digital
          </label>
          <label class="accion-option">
            <input type="checkbox" class="accion-chk" value="ReforestaciÃ³n"> ğŸŒ³ ReforestaciÃ³n
          </label>
          <label class="accion-option">
            <input type="checkbox" class="accion-chk" value="Productos ecolÃ³gicos"> ğŸ§´ Productos ecolÃ³gicos
          </label>
          <label class="accion-option">
            <input type="checkbox" class="accion-chk" value="Voluntariado ambiental"> ğŸ¤ Voluntariado
          </label>
          <label class="accion-option">
            <input type="checkbox" class="accion-chk" value="Reparar objetos"> ğŸ§© Reparar objetos
          </label>
          <label class="accion-option">
            <input type="checkbox" class="accion-chk" value="FormaciÃ³n ambiental"> ğŸ“š FormaciÃ³n ambiental
          </label>
          <label class="accion-option">
            <input type="checkbox" class="accion-chk" value="JardÃ­n polinizadores"> ğŸ JardÃ­n polinizadores
          </label>
        </div>

        <label>Frecuencia</label>
        <select id="frecuencia" class="input">
            <option value="Semanal">Semanal</option>
            <option value="Diaria">Diaria</option>
            <option value="Ocasional">Ocasional</option>
            <option value="Primera vez">Primera vez</option>
        </select>

        <label>Comentario o reflexiÃ³n</label>
        <textarea id="comentario" class="input" rows="3" placeholder="Â¿CuÃ¡l fue tu acciÃ³n mÃ¡s significativa? Â¿QuÃ© aprendiste?"></textarea>

        <label>Impacto estimado (kg COâ‚‚ evitados)</label>
        <input type="number" id="impactoCo2" class="input" placeholder="Ej: 2.5" step="0.1" min="0">

        <button id="btnEnviar" class="btn btn-primary" type="button" onclick="enviarReporte()">ğŸš€ Registrar Impacto</button>
      </form>

      <div id="mensajeBox" style="margin-top:20px; text-align:center; padding:10px; border-radius:8px;" class="hidden"></div>

      <div id="historyBox" class="hidden" style="margin-top:30px; border-top:1px solid rgba(255,255,255,0.1); padding-top:20px;">
          <h3 style="color:var(--accent); text-align:center;">ğŸ“Š Tu Historial de Impacto</h3>
          <div id="listaHistorial"></div>
      </div>

      <div style="margin-top:30px; text-align:center; color:var(--muted); font-size:0.9rem; border-top:1px solid rgba(255,255,255,0.1); padding-top:15px;">
        ğŸ”— <strong>Conectado a Dashboard Global BlueSphere</strong><br>
        Tus acciones se suman automÃ¡ticamente al impacto colectivo.
      </div>

    </div>
  </div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

// 1. CONEXIÃ“N SUPABASE
const SUPABASE_URL = 'https://ophicpcbgdgzthjamzoz.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9waGljcGNiZ2RnenRoamFtem96Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ3MjgwMzUsImV4cCI6MjA4MDMwNDAzNX0.K55Tk-cdbAFDOtGrIMN7vYFaJAccrsD6UdOrARt1P5c';
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// 2. AUTO-DETECTAR (Si viene del Portal)
const params = new URLSearchParams(window.location.search);
const codigoURL = params.get('codigo');

if (codigoURL) {
    document.getElementById('codigoInput').value = codigoURL;
    cargarHistorial(codigoURL);
}

// 3. FUNCIÃ“N: VALIDAR Y BUSCAR (BotÃ³n Lupa)
async function validarYBuscar() {
    const codigo = document.getElementById('codigoInput').value.trim();
    if(codigo) {
        cargarHistorial(codigo);
    } else {
        alert("Escribe un cÃ³digo primero.");
    }
}

// 4. FUNCIÃ“N: ENVIAR REPORTE (BotÃ³n Registrar)
async function enviarReporte() {
    const codigo = document.getElementById('codigoInput').value.trim();
    if (!codigo) return alert('Falta el cÃ³digo de guardiÃ¡n');

    // Recoger acciones
    let acciones = [];
    document.querySelectorAll('.accion-chk:checked').forEach(c => acciones.push(c.value));
    
    if (acciones.length === 0) return alert('Selecciona al menos una acciÃ³n');

    const frecuencia = document.getElementById('frecuencia').value;
    const comentario = document.getElementById('comentario').value;
    const impactoCo2 = document.getElementById('impactoCo2').value || (acciones.length * 0.5);

    mostrarMensaje("Enviando...", "#fff");

    // Guardar en Supabase (Tabla 'seguimiento')
    const { error } = await supabase
        .from('seguimiento')
        .insert([{
            codigo_guardian: codigo,
            acciones_realizadas: acciones.join(', '),
            frecuencia: frecuencia,
            comentario: comentario,
            impacto_co2: parseFloat(impactoCo2),
            fecha_reporte: new Date().toISOString()
        }]);

    if (error) {
        mostrarMensaje('Error: ' + error.message, '#ff7b7b');
    } else {
        document.getElementById('seguimientoForm').reset();
        document.getElementById('codigoInput').value = codigo; 
        document.getElementById('impactoCo2').value = '';
        mostrarMensaje('âœ… Reporte guardado con Ã©xito. Â¡Gracias por tu impacto!', '#3ddc84');
        cargarHistorial(codigo);
    }
}

// 5. FUNCIÃ“N: CARGAR HISTORIAL
async function cargarHistorial(codigo) {
    const { data, error } = await supabase
        .from('seguimiento')
        .select('*')
        .eq('codigo_guardian', codigo)
        .order('fecha_reporte', { ascending: false });

    const lista = document.getElementById('listaHistorial');
    const caja = document.getElementById('historyBox');
    
    if (data && data.length > 0) {
        caja.classList.remove('hidden');
        
        // Calcular total de impacto
        const totalImpacto = data.reduce((sum, item) => sum + (item.impacto_co2 || 0), 0);
        
        lista.innerHTML = `
            <div style="text-align:center; margin-bottom:15px; padding:10px; background:rgba(61,220,132,0.1); border-radius:8px;">
                <strong>ğŸŒ± Impacto total acumulado:</strong> ${totalImpacto.toFixed(2)} kg COâ‚‚ evitados
            </div>
        `;
        
        lista.innerHTML += data.map(item => `
            <div class="history-item">
                <div style="font-weight:bold; color:var(--accent)">
                    ${new Date(item.fecha_reporte).toLocaleDateString('es-ES', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' })}
                </div>
                <div>${item.acciones_realizadas}</div>
                <div style="color:#81d4fa; font-size:0.9rem; margin:5px 0;">
                    ğŸŒ¿ ${item.impacto_co2 ? item.impacto_co2 + ' kg COâ‚‚ evitados' : 'Impacto registrado'}
                </div>
                <div class="tiny">"${item.comentario || 'Sin comentarios'}"</div>
            </div>
        `).join('');
    } else {
        caja.classList.remove('hidden');
        lista.innerHTML = '<div class="tiny" style="text-align:center; padding:20px;">No hay reportes previos. SÃ© el primero en registrar tu impacto.</div>';
    }
}

// 6. UTILS
function mostrarMensaje(texto, color) {
    const box = document.getElementById('mensajeBox');
    box.textContent = texto;
    box.style.color = color;
    box.style.border = `1px solid ${color}`;
    box.style.background = color === '#3ddc84' ? 'rgba(61,220,132,0.1)' : 'rgba(255,255,255,0.05)';
    box.classList.remove('hidden');
    setTimeout(() => box.classList.add('hidden'), 5000);
}

// Calcular impacto automÃ¡tico basado en acciones seleccionadas
document.querySelectorAll('.accion-chk').forEach(checkbox => {
    checkbox.addEventListener('change', function() {
        const checked = document.querySelectorAll('.accion-chk:checked').length;
        document.getElementById('impactoCo2').value = (checked * 0.5).toFixed(1);
    });
});

// --- LA CLAVE: CONECTAR BOTONES AL WINDOW ---
window.enviarReporte = enviarReporte;
window.validarYBuscar = validarYBuscar;

</script>
</body>
</html>
