<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Seguimiento</title>
<style>
  :root{ --bg:#041016; --card:#07212a; --accent:#4fc3f7; --muted:#c8eaff; --success:#3ddc84; --white:#ffffff; }
  body{font-family:Inter, sans-serif; background:var(--bg); color:var(--white); margin:0; padding:20px;}
  .wrap{max-width:800px; margin:20px auto;}
  .card{background:var(--card); border-radius:12px; padding:25px; border:1px solid rgba(127,206,255,0.1);}
  
  h1{color:var(--accent); margin:0 0 10px; font-size:2rem; text-align:center;}
  p.lead{color:var(--muted); text-align:center; margin-bottom:30px;}

  .input, textarea, select{width:100%; padding:12px; border-radius:8px; border:1px solid #19434d; background:#021219; color:var(--white); box-sizing:border-box; margin-bottom:15px;}
  label{display:block; color:var(--muted); margin-bottom:8px; font-weight:bold;}
  
  .btn{padding:12px 20px; border-radius:8px; cursor:pointer; border:0; font-weight:bold; width:100%; font-size:1rem;}
  .btn-primary{background:linear-gradient(135deg,var(--accent),#81d4fa); color:#041016;}
  .btn-plain{background:transparent; border:1px solid rgba(255,255,255,0.2); color:var(--muted); margin-top:10px;}
  
  .history-item{background:rgba(255,255,255,0.03); padding:15px; border-radius:8px; margin-bottom:10px; border-left: 3px solid var(--success);}
  .tiny{font-size:0.85rem; color:var(--muted);}
  .hidden { display: none !important; }
</style>
</head>
<body>

  <div class="wrap">
    <div class="card">
      
      <h1>Seguimiento</h1>
      <p class="lead">Reporte de actividad del Guardi√°n</p>

      <label>Tu C√≥digo de Guardi√°n</label>
      <input id="codigoInput" class="input" placeholder="Ej: GPR-AQUA-0021">
      <button class="btn btn-plain" onclick="validarYBuscar()">üîç Cargar mi Historial</button>

      <form id="seguimientoForm" style="margin-top:20px;">
        <label>Acciones realizadas hoy</label>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:15px;">
            <label><input type="checkbox" class="accion-chk" value="Pl√°stico"> ü•§ Menos Pl√°stico</label>
            <label><input type="checkbox" class="accion-chk" value="Transporte"> üö≤ Transporte</label>
            <label><input type="checkbox" class="accion-chk" value="Agua"> üíß Ahorro Agua</label>
            <label><input type="checkbox" class="accion-chk" value="Consumo"> üå± Consumo Local</label>
        </div>

        <label>Frecuencia</label>
        <select id="frecuencia" class="input">
            <option value="Semanal">Semanal</option>
            <option value="Diaria">Diaria</option>
            <option value="Ocasional">Ocasional</option>
        </select>

        <label>Comentario</label>
        <textarea id="comentario" class="input" rows="3" placeholder="Detalles de tu avance..."></textarea>

        <button id="btnEnviar" class="btn btn-primary" type="button" onclick="enviarReporte()">üöÄ Registrar Impacto</button>
      </form>

      <div id="mensajeBox" style="margin-top:20px; text-align:center; padding:10px; border-radius:8px;" class="hidden"></div>

      <div id="historyBox" class="hidden" style="margin-top:30px; border-top:1px solid rgba(255,255,255,0.1); padding-top:20px;">
          <h3 style="color:var(--accent); text-align:center;">Tu Historial</h3>
          <div id="listaHistorial"></div>
      </div>

    </div>
  </div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

// 1. CONEXI√ìN SUPABASE
const SUPABASE_URL = 'https://ophicpcbgdgzthjamzoz.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9waGljcGNiZ2RnenRoamFtem96Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ3MjgwMzUsImV4cCI6MjA4MDMwNDAzNX0.K55Tk-cdbAFDOtGrIMN7vYFaJAccrsD6UdOrARt1P5c';
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// 2. AUTO-DETECTAR (Si viene del Portal)
const params = new URLSearchParams(window.location.search);
const codigoURL = params.get('codigo');

if (codigoURL) {
    document.getElementById('codigoInput').value = codigoURL;
    cargarHistorial(codigoURL);
}

// 3. FUNCI√ìN: VALIDAR Y BUSCAR (Bot√≥n Lupa)
async function validarYBuscar() {
    const codigo = document.getElementById('codigoInput').value.trim();
    if(codigo) {
        cargarHistorial(codigo);
    } else {
        alert("Escribe un c√≥digo primero.");
    }
}

// 4. FUNCI√ìN: ENVIAR REPORTE (Bot√≥n Registrar)
async function enviarReporte() {
    const codigo = document.getElementById('codigoInput').value.trim();
    if (!codigo) return alert('Falta el c√≥digo de guardi√°n');

    // Recoger acciones
    let acciones = [];
    document.querySelectorAll('.accion-chk:checked').forEach(c => acciones.push(c.value));
    
    if (acciones.length === 0) return alert('Selecciona al menos una acci√≥n');

    const frecuencia = document.getElementById('frecuencia').value;
    const comentario = document.getElementById('comentario').value;

    mostrarMensaje("Enviando...", "#fff");

    // Guardar en Supabase (Tabla 'seguimiento')
    const { error } = await supabase
        .from('seguimiento')
        .insert([{
            codigo_guardian: codigo,
            acciones_realizadas: acciones.join(', '),
            frecuencia: frecuencia,
            comentario: comentario,
            impacto_co2: acciones.length * 0.5 
        }]);

    if (error) {
        mostrarMensaje('Error: ' + error.message, '#ff7b7b');
    } else {
        document.getElementById('seguimientoForm').reset();
        document.getElementById('codigoInput').value = codigo; 
        mostrarMensaje('‚úÖ Reporte guardado con √©xito', '#3ddc84');
        cargarHistorial(codigo);
    }
}

// 5. FUNCI√ìN: CARGAR HISTORIAL
async function cargarHistorial(codigo) {
    const { data, error } = await supabase
        .from('seguimiento')
        .select('*')
        .eq('codigo_guardian', codigo)
        .order('fecha_reporte', { ascending: false });

    const lista = document.getElementById('listaHistorial');
    const caja = document.getElementById('historyBox');
    
    if (data && data.length > 0) {
        caja.classList.remove('hidden');
        lista.innerHTML = data.map(item => `
            <div class="history-item">
                <div style="font-weight:bold; color:var(--accent)">${new Date(item.fecha_reporte).toLocaleDateString()}</div>
                <div>${item.acciones_realizadas}</div>
                <div class="tiny">"${item.comentario || 'Sin comentarios'}"</div>
            </div>
        `).join('');
    } else {
        caja.classList.remove('hidden');
        lista.innerHTML = '<div class="tiny" style="text-align:center">No hay reportes previos. S√© el primero.</div>';
    }
}

// 6. UTILS
function mostrarMensaje(texto, color) {
    const box = document.getElementById('mensajeBox');
    box.textContent = texto;
    box.style.color = color;
    box.style.border = `1px solid ${color}`;
    box.classList.remove('hidden');
    setTimeout(() => box.classList.add('hidden'), 4000);
}

// --- LA CLAVE: CONECTAR BOTONES AL WINDOW ---
window.enviarReporte = enviarReporte;
window.validarYBuscar = validarYBuscar;

</script>
</body>
</html>
