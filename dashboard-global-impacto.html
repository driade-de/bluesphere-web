<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Global BlueSphere - Master</title>
    
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- ESTILOS VISUALES (Dark Ghibli Tech) --- */
        :root {
            --bg: #020b10; 
            --card: #061b24; 
            --accent: #00c4ff;
            --success: #4caf50; 
            --warning: #ff9800; 
            --danger: #f44336;
            --text: #eaffff; 
            --muted: #8fb3c4;
            --card-border: 1px solid rgba(0, 196, 255, 0.15);
        }
        
        body { margin: 0; padding: 0; background: var(--bg); color: var(--text); font-family: 'Segoe UI', system-ui, sans-serif; overflow-x: hidden; }
        .container { max-width: 1600px; margin: 0 auto; padding: 20px; }
        
        /* HEADER */
        .header { 
            background: linear-gradient(90deg, #061b24, #0a2e3d); 
            padding: 25px; border-radius: 15px; 
            border: var(--card-border); 
            margin-bottom: 25px; 
            display: flex; justify-content: space-between; align-items: center; 
            box-shadow: 0 4px 30px rgba(0,0,0,0.5);
        }
        .header h1 { margin: 0; color: var(--accent); font-size: 1.8rem; letter-spacing: 1px; text-transform: uppercase; }
        .header p { margin: 5px 0 0; color: var(--muted); font-size: 0.9rem; }
        
        .filtros { display: flex; gap: 10px; }
        .btn-filtro { 
            background: rgba(0, 196, 255, 0.05); border: 1px solid var(--muted); 
            color: var(--muted); padding: 8px 16px; border-radius: 20px; 
            cursor: pointer; font-size: 0.85rem; transition: all 0.3s;
        }
        .btn-filtro.activo { background: var(--accent); color: #000; border-color: var(--accent); font-weight: bold; }

        /* KPIS PRINCIPALES */
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .kpi-card { 
            background: var(--card); padding: 25px; border-radius: 15px; 
            border: var(--card-border); position: relative; overflow: hidden; 
            transition: transform 0.3s;
        }
        .kpi-card:hover { transform: translateY(-5px); border-color: var(--accent); }
        .kpi-icon { font-size: 2rem; margin-bottom: 10px; }
        .kpi-num { font-size: 2.2rem; font-weight: 800; margin: 5px 0; color: #fff; }
        .kpi-trend { font-size: 0.85rem; color: var(--success); display: flex; align-items: center; gap: 5px; }
        .kpi-label { font-size: 0.9rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; margin-top: 5px; }

        /* BARRA DE IMPACTO */
        .impacto-bar { 
            background: linear-gradient(90deg, rgba(76, 175, 80, 0.15), rgba(0, 196, 255, 0.15)); 
            border: 1px solid var(--success); border-radius: 12px; padding: 20px; 
            text-align: center; margin-bottom: 30px; font-size: 1.1rem; 
            color: #a5d6a7; text-shadow: 0 0 10px rgba(76, 175, 80, 0.3);
        }

        /* MODULOS CONEXI√ìN (La fila de iconos peque√±os) */
        .modulos-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .modulo-item { 
            background: rgba(255,255,255,0.03); border-radius: 10px; padding: 15px; 
            text-align: center; border: 1px solid transparent; 
        }
        .modulo-item.active { border-color: var(--accent); background: rgba(0, 196, 255, 0.05); }
        .mod-val { font-size: 1.4rem; font-weight: bold; color: #fff; display: block; margin: 5px 0; }
        .mod-lbl { font-size: 0.75rem; color: var(--muted); text-transform: uppercase; }

        /* GRID PRINCIPAL (Gr√°ficas vs Listas) */
        .main-layout { display: grid; grid-template-columns: 2fr 1fr; gap: 25px; }
        @media(max-width: 1024px) { .main-layout { grid-template-columns: 1fr; } }

        .panel { 
            background: var(--card); border-radius: 15px; padding: 25px; 
            border: var(--card-border); margin-bottom: 25px; 
        }
        .panel h3 { margin-top: 0; color: var(--accent); font-size: 1.1rem; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px; margin-bottom: 20px; }

        /* Listas (Ranking, Guardianes) */
        .list-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .list-row:last-child { border-bottom: none; }
        .rank-badge { background: var(--warning); color: #000; width: 24px; height: 24px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.8rem; margin-right: 10px; }
        
        /* Mapa */
        .map-box { height: 350px; background: radial-gradient(circle at center, #0a2e3d, #020b10); border-radius: 10px; position: relative; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        .map-dot { position: absolute; width: 10px; height: 10px; border-radius: 50%; animation: pulse 2s infinite; }
        .dot-high { background: var(--success); box-shadow: 0 0 15px var(--success); }
        .dot-mid { background: var(--warning); box-shadow: 0 0 10px var(--warning); }
        .dot-low { background: var(--accent); box-shadow: 0 0 10px var(--accent); }

        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.5); opacity: 0.5; } 100% { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body>

<div class="container">
    
    <div class="header">
        <div>
            <h1>Dashboard Global BlueSphere</h1>
            <p>Sistema de Conciencia Planetaria - Impacto Colectivo en Tiempo Real</p>
        </div>
        <div class="filtros">
            <button class="btn-filtro activo">üìä Hoy</button>
            <button class="btn-filtro">üìà Semana</button>
            <button class="btn-filtro">üìÖ Mes</button>
            <button class="btn-filtro">üåê Total</button>
        </div>
    </div>

    <div class="kpi-grid">
        <div class="kpi-card">
            <div class="kpi-icon">üè¢</div>
            <div class="kpi-num" id="kpi-empresas">0</div>
            <div class="kpi-trend">‚ñ≤ +15 esta semana</div>
            <div class="kpi-label">Empresas Aliadas</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-icon">üìä</div>
            <div class="kpi-num" id="kpi-checkins">0</div>
            <div class="kpi-trend">‚ñ≤ +2,847 hoy</div>
            <div class="kpi-label">Check-ins Activos</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-icon">üèÜ</div>
            <div class="kpi-num" id="kpi-medallas">0</div>
            <div class="kpi-trend">‚ñ≤ +3,421 esta semana</div>
            <div class="kpi-label">Medallas Otorgadas</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-icon">üìö</div>
            <div class="kpi-num" id="kpi-certificados">0</div>
            <div class="kpi-trend">‚ñ≤ +892 este mes</div>
            <div class="kpi-label">Certificados</div>
        </div>
    </div>

    <div class="impacto-bar">
    üå± IMPACTO ACUMULADO: 
    <span style="color:#fff" id="display-co2">0 kg CO‚ÇÇ</span> evitados ‚Ä¢ 
    <span style="color:#fff" id="display-plastico">0 kg</span> pl√°stico ‚Ä¢ 
    <span style="color:#fff" id="display-agua">0 L</span> agua
</div>

    <div class="modulos-grid">
        <div class="modulo-item">
            <div>üîë</div>
            <span class="mod-val">1,247</span>
            <span class="mod-lbl">Portal Empresas</span>
        </div>
        <div class="modulo-item active">
            <div>üåä</div>
            <span class="mod-val" id="real-pactos-count">Cargando...</span>
            <span class="mod-lbl">Pactos Firmados (Real)</span>
        </div>
        <div class="modulo-item">
            <div>üìä</div>
            <span class="mod-val">45,892</span>
            <span class="mod-lbl">Seguimiento</span>
        </div>
        <div class="modulo-item">
            <div>üèÜ</div>
            <span class="mod-val">128,456</span>
            <span class="mod-lbl">Medallas</span>
        </div>
    </div>

    <div class="main-layout">
        
        <div class="left-col">
            
            <div class="panel">
                <h3>üìà Evoluci√≥n de Impacto Mensual</h3>
                <canvas id="chartEvolucion" height="100"></canvas>
            </div>

            <div class="panel">
                <h3>üó∫Ô∏è Mapa de Impacto Global</h3>
                <div class="map-box" id="mapaGlobal">
                    <span style="z-index:2; color:var(--muted)">Visualizaci√≥n de Nodos Activos</span>
                    </div>
                <div style="margin-top:10px; font-size:0.8rem; text-align:center;">
                    <span style="color:var(--success)">‚óè Alto</span> &nbsp;
                    <span style="color:var(--warning)">‚óè Medio</span> &nbsp;
                    <span style="color:var(--accent)">‚óè Creciente</span>
                </div>
            </div>

            <div class="panel">
                <h3>üìä Distribuci√≥n de Acciones</h3>
                <div style="display:flex; justify-content:space-around; text-align:center; align-items:center;">
                    <div style="width:150px"><canvas id="chartDistribucion"></canvas></div>
                    <div style="text-align:left;">
                        <div style="margin-bottom:10px;">
                            <div style="color:var(--accent); font-weight:bold;">90% Pacto Azul</div>
                            <div style="font-size:0.8rem; color:gray;">Tasa Finalizaci√≥n</div>
                        </div>
                        <div style="margin-bottom:10px;">
                            <div style="color:var(--success); font-weight:bold;">78% Biblioteca</div>
                            <div style="font-size:0.8rem; color:gray;">Libros Descargados</div>
                        </div>
                        <div>
                            <div style="color:var(--warning); font-weight:bold;">3.2 Medallas</div>
                            <div style="font-size:0.8rem; color:gray;">Promedio/Empresa</div>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <div class="right-col">
            
            <div class="panel" style="border-color:var(--accent);">
                <h3>üåä √öltimos Guardianes (En Vivo)</h3>
                <div id="lista-real-guardianes">
                    <p style="color:gray; text-align:center;">Conectando...</p>
                </div>
            </div>

            <div class="panel" style="border-color: var(--success); background: linear-gradient(180deg, var(--card), #0a2e3d);">
    <h3>üåø Ecosistema de Ofrendas (Impacto en Vivo)</h3>
    <div id="ranking-habitos-dinamico">
        <p style="color:var(--muted); text-align:center; padding: 20px;">
            <span class="loading-pulse">üõ∞Ô∏è Sincronizando con los 18 h√°bitos...</span>
        </p>
    </div>
</div>

            <div class="panel">
                <h3>üéñÔ∏è Medallas Recientes</h3>
                <div class="list-row">
                    <div>
                        <div style="font-weight:bold;">‚≠ê EcoTech Solutions</div>
                        <div style="font-size:0.75rem; color:var(--muted)">Excelencia Azul</div>
                    </div>
                    <div style="font-size:0.8rem; color:var(--success)">hoy</div>
                </div>
                <div class="list-row">
                    <div>
                        <div style="font-weight:bold;">üèÖ Green Logistics</div>
                        <div style="font-size:0.75rem; color:var(--muted)">Compromiso 15 d√≠as</div>
                    </div>
                    <div style="font-size:0.8rem; color:var(--success)">ayer</div>
                </div>
                <div class="list-row">
                    <div>
                        <div style="font-weight:bold;">üì∏ AquaPure Systems</div>
                        <div style="font-size:0.75rem; color:var(--muted)">Verificador Experto</div>
                    </div>
                    <div style="font-size:0.8rem; color:var(--muted)">2 d√≠as</div>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
    // --- 1. CONEXI√ìN SUPABASE REAL ---
    const SB_URL = 'https://ophicpcbgdgzthjamzoz.supabase.co';
    const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9waGljcGNiZ2RnenRoamFtem96Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ3MjgwMzUsImV4cCI6MjA4MDMwNDAzNX0.K55Tk-cdbAFDOtGrIMN7vYFaJAccrsD6UdOrARt1P5c';
    const supabase = window.supabase.createClient(SB_URL, SB_KEY);

    // --- 2. INICIALIZAR ---
    window.onload = function() {
        renderCharts();
        animarMapa();
        cargarDatosReales();
        
        // Auto-refresh datos reales cada 10s
        setInterval(cargarDatosReales, 10000);
    };

    // --- 3. DATOS REALES DE SUPABASE (CONEXI√ìN INTERESTELAR) ---
    async function cargarDatosReales() {
        // A. Contar Pactos (Firmantes)
        const { count: countFirmantes } = await supabase
            .from('firmantes')
            .select('*', { count: 'exact', head: true });
        
        if(countFirmantes) {
            document.getElementById('real-pactos-count').innerText = countFirmantes.toLocaleString();
        }

       // B. TRAER IMPACTO REAL DESDE 'SEGUIMIENTO' (LOS 18 H√ÅBITOS)
const { data: seguimientos, error: errSeg } = await supabase
    .from('seguimiento')
    .select('impacto_co2, acciones_realizadas, codigo_guardian, fecha_reporte');

if (seguimientos) {
    // 1. Calcular CO2 Total Real (Sumamos los registros de la tabla)
    const co2Acumulado = seguimientos.reduce((sum, s) => sum + (s.impacto_co2 || 0), 0);
    
    // CAMBIO CLAVE: Quitamos el "8514520" para que empiece desde CERO REAL
    const totalDisplay = co2Acumulado.toLocaleString(); 
    document.querySelector('.impacto-bar span').innerText = `${totalDisplay} kg CO‚ÇÇ`;

    // 2. Procesar los 18 h√°bitos para el Ranking
    const conteoHabitos = {};
    seguimientos.forEach(s => {
        // Validaci√≥n de seguridad por si el campo est√° vac√≠o
        if (s.acciones_realizadas) {
            const lista = s.acciones_realizadas.split(', ');
            lista.forEach(habito => {
                conteoHabitos[habito] = (conteoHabitos[habito] || 0) + 1;
            });
        }
    });
    actualizarRankingVisual(conteoHabitos);
}

            // 3. Renderizar √∫ltimos 5 Guardianes Activos
            let htmlGuardianes = '';
            const ultimos5 = seguimientos.sort((a,b) => new Date(b.fecha_reporte) - new Date(a.fecha_reporte)).slice(0, 5);
            
            ultimos5.forEach(u => {
                htmlGuardianes += `
                <div class="list-row">
                    <div>
                        <div style="font-weight:bold; color:#fff;">Guardi√°n ${u.codigo_guardian.substring(0,8)}...</div>
                        <div style="font-size:0.7rem; color:var(--accent);">Aport√≥ +${u.impacto_co2} kg de Consciencia</div>
                    </div>
                    <div style="font-size:0.75rem; color:gray;">Activo</div>
                </div>`;
            });
            document.getElementById('lista-real-guardianes').innerHTML = htmlGuardianes;
        }
    }

    // FUNCI√ìN AUXILIAR PARA EL RANKING GHIBLI (DIBUJO INTERESTELAR)
    function actualizarRankingVisual(datos) {
        const rankingBox = document.getElementById('ranking-habitos-dinamico');
        if (!rankingBox) return;

        // Ordenamos los 18 h√°bitos por frecuencia de mayor a menor
        const ordenados = Object.entries(datos).sort((a,b) => b[1] - a[1]).slice(0, 6);
        
        let html = '';
        ordenados.forEach(([nombre, total], index) => {
            // Limpiamos el nombre t√©cnico para mostrarlo con orgullo
            const nombreSagrado = nombre.replace(/_/g, ' ').toUpperCase();
            
            html += `
            <div class="list-row" style="border-bottom: 1px solid rgba(0, 196, 255, 0.15); animation: pulse 2s infinite;">
                <div style="display: flex; align-items: center;">
                    <span class="rank-badge" style="background: var(--accent); color: #000; font-size: 0.7rem;">${index + 1}</span>
                    <span style="font-size: 0.8rem; font-weight: bold; letter-spacing: 1px;">${nombreSagrado}</span>
                </div>
                <div style="color: var(--success); font-weight: bold; font-family: 'Courier New', monospace;">
                    ${total} <small style="font-size: 0.6rem; color: var(--muted);">RECUENTOS</small>
                </div>
            </div>`;
        });
        
        rankingBox.innerHTML = html || '<p style="color:gray; text-align:center;">Escaneando el campo cu√°ntico...</p>';
    }
    // --- 4. GR√ÅFICAS (Chart.js) ---
    function renderCharts() {
        // Gr√°fico L√≠nea (Evoluci√≥n)
        new Chart(document.getElementById('chartEvolucion'), {
            type: 'line',
            data: {
                labels: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul'],
                datasets: [{
                    label: 'Impacto Acumulado',
                    data: [120, 350, 500, 750, 1100, 1400, 1800],
                    borderColor: '#00c4ff',
                    backgroundColor: 'rgba(0, 196, 255, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { display: false } },
                scales: { 
                    y: { grid: { color: 'rgba(255,255,255,0.05)' } },
                    x: { grid: { display: false } }
                }
            }
        });

        // Gr√°fico Donut (Distribuci√≥n)
        new Chart(document.getElementById('chartDistribucion'), {
            type: 'doughnut',
            data: {
                labels: ['Pacto', 'Biblio', 'Medallas'],
                datasets: [{
                    data: [90, 78, 45],
                    backgroundColor: ['#00c4ff', '#4caf50', '#ff9800'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { display: false } }
            }
        });
    }

    // --- 5. MAPA ANIMADO (Sincronizado con Guardianes Reales) ---
    function animarMapa(totalGuardianes = 4) {
        const mapa = document.getElementById('mapaGlobal');
        if (!mapa) return;
        
        // Limpiamos puntos anteriores para la actualizaci√≥n
        mapa.innerHTML = '<span style="z-index:2; color:var(--muted)">Visualizaci√≥n de Nodos Activos</span>';
        
        // Creamos puntos basados en el n√∫mero real de Guardianes (m√≠nimo 4 por tus Guardianes Reales)
        const puntosACrear = Math.min(totalGuardianes, 50); 

        for(let i=0; i < puntosACrear; i++) {
            let dot = document.createElement('div');
            // Estilo Ghibli: Diferentes intensidades de azul y verde
            dot.className = i % 3 === 0 ? 'map-dot dot-high' : (i % 2 === 0 ? 'map-dot dot-mid' : 'map-dot dot-low');
            
            // Posicionamiento aleatorio en el "globo"
            dot.style.left = Math.floor(Math.random() * 90) + '%';
            dot.style.top = Math.floor(Math.random() * 70 + 15) + '%';
            dot.style.animationDelay = Math.random() * 3 + 's';
            
            mapa.appendChild(dot);
        }
    }
</script>

</body>
</html>
