<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Global BlueSphere</title>
    
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- ESTILOS GHIBLI TECH --- */
        :root {
            --bg: #020b10; --card: #061b24; --accent: #00c4ff;
            --success: #4caf50; --warning: #ff9800; --danger: #f44336;
            --text: #eaffff; --muted: #8fb3c4;
        }
        body { margin: 0; padding: 0; background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; }
        
        .container { max-width: 1600px; margin: 0 auto; padding: 20px; }
        
        /* Header */
        .header { background: linear-gradient(90deg, #061b24, #0a2e3d); padding: 25px; border-radius: 12px; border: 1px solid #1a3d4d; margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { margin: 0; color: var(--accent); font-size: 1.8rem; text-transform: uppercase; letter-spacing: 2px; }
        .badges { display: flex; gap: 10px; }
        .badge { background: rgba(0, 196, 255, 0.1); border: 1px solid var(--accent); padding: 5px 15px; border-radius: 20px; font-size: 0.8rem; color: var(--accent); }

        /* Grid Superior */
        .top-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .kpi-card { background: var(--card); padding: 20px; border-radius: 12px; border-top: 3px solid var(--muted); box-shadow: 0 4px 20px rgba(0,0,0,0.3); transition: transform 0.2s; }
        .kpi-card:hover { transform: translateY(-5px); border-top-color: var(--accent); }
        .kpi-icon { font-size: 1.5rem; margin-bottom: 10px; }
        .kpi-value { font-size: 2rem; font-weight: bold; margin: 5px 0; color: #fff; }
        .kpi-sub { font-size: 0.8rem; color: var(--success); }
        .kpi-label { font-size: 0.9rem; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; }

        /* Impacto Bar */
        .impacto-bar { background: linear-gradient(90deg, rgba(76,175,80,0.1), rgba(0,196,255,0.1)); border: 1px solid var(--success); padding: 15px; border-radius: 10px; text-align: center; margin-bottom: 25px; color: #a5d6a7; font-weight: bold; font-size: 1.1rem; }

        /* Main Grid */
        .main-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 25px; }
        @media(max-width: 1000px) { .main-grid { grid-template-columns: 1fr; } }

        .panel { background: var(--card); padding: 25px; border-radius: 12px; border: 1px solid #1a3d4d; margin-bottom: 25px; }
        .panel h3 { margin-top: 0; color: var(--accent); border-bottom: 1px solid #1a3d4d; padding-bottom: 15px; }

        /* Listas */
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .rank-num { background: var(--accent); color: #000; width: 24px; height: 24px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.8rem; margin-right: 10px; }
        
        /* Map Placeholder */
        .map-placeholder { height: 300px; background: radial-gradient(circle, #0a2e3d, #020b10); border-radius: 10px; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden; }
        .dot { position: absolute; width: 8px; height: 8px; background: var(--success); border-radius: 50%; box-shadow: 0 0 10px var(--success); animation: pulse 2s infinite; }

        @keyframes pulse { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(1.5); } 100% { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body>

<div class="container">
    
    <div class="header">
        <div>
            <h1>Dashboard Global BlueSphere</h1>
            <div style="color:var(--muted); font-size:0.9rem;">Sistema de Conciencia Planetaria - Impacto Colectivo</div>
        </div>
        <div class="badges">
            <div class="badge">üìä Hoy</div>
            <div class="badge">üìà Esta Semana</div>
            <div class="badge">üåê Total</div>
        </div>
    </div>

    <div class="top-grid">
        <div class="kpi-card">
            <div class="kpi-icon">üè¢</div>
            <div class="kpi-value">1,305</div>
            <div class="kpi-sub">‚ñ≤ +15 esta semana</div>
            <div class="kpi-label">Empresas Aliadas</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-icon">üåä</div>
            <div class="kpi-value" id="kpi-pactos">Cargando...</div>
            <div class="kpi-sub">‚ñ≤ Actividad Real</div>
            <div class="kpi-label">Pactos Firmados</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-icon">üèÜ</div>
            <div class="kpi-value">129,418</div>
            <div class="kpi-sub">‚ñ≤ +3,421 esta semana</div>
            <div class="kpi-label">Medallas Otorgadas</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-icon">üìö</div>
            <div class="kpi-value">34,567</div>
            <div class="kpi-sub">‚ñ≤ +892 este mes</div>
            <div class="kpi-label">Certificados</div>
        </div>
    </div>

    <div class="impacto-bar" id="impacto-ambiental">
        üå± Calculando impacto en tiempo real...
    </div>

    <div class="main-grid">
        
        <div class="left-col">
            
            <div class="panel">
                <h3>üìà Evoluci√≥n de Impacto Mensual</h3>
                <canvas id="chartImpacto" height="100"></canvas>
            </div>

            <div class="panel">
                <h3>üó∫Ô∏è Mapa de Impacto Global</h3>
                <div class="map-placeholder" id="mapa">
                    <span style="z-index:2">Visualizaci√≥n de Nodos Activos</span>
                    </div>
            </div>

            <div class="panel">
                <h3>üìä Distribuci√≥n por Tipo</h3>
                <div style="display:flex; justify-content:space-around; text-align:center;">
                    <div>
                        <div style="font-size:1.5rem; color:var(--accent); font-weight:bold;">90%</div>
                        <div style="font-size:0.8rem; color:var(--muted);">Tasa Finalizaci√≥n</div>
                    </div>
                    <div>
                        <div style="font-size:1.5rem; color:var(--success); font-weight:bold;">78%</div>
                        <div style="font-size:0.8rem; color:var(--muted);">Libros Descargados</div>
                    </div>
                    <div>
                        <div style="font-size:1.5rem; color:var(--warning); font-weight:bold;">3.2</div>
                        <div style="font-size:0.8rem; color:var(--muted);">Promedio/Empresa</div>
                    </div>
                </div>
            </div>

        </div>

        <div class="right-col">
            
            <div class="panel">
                <h3>üåä √öltimos Guardianes (Real)</h3>
                <div id="lista-guardianes">
                    <p style="color:gray">Cargando datos...</p>
                </div>
            </div>

            <div class="panel">
                <h3>üèÖ Ranking Empresas Top</h3>
                <div class="list-item">
                    <div><span class="rank-num">1</span> EcoTech Solutions</div>
                    <div style="color:var(--success)">45,200 kg</div>
                </div>
                <div class="list-item">
                    <div><span class="rank-num">2</span> Green Logistics MX</div>
                    <div style="color:var(--success)">38,750 kg</div>
                </div>
                <div class="list-item">
                    <div><span class="rank-num">3</span> AquaPure Systems</div>
                    <div style="color:var(--success)">32,100 kg</div>
                </div>
            </div>

            <div class="panel">
                <h3>üéñÔ∏è Medallas Recientes</h3>
                <div class="list-item">
                    <div>‚≠ê EcoTech Solutions</div>
                    <div style="font-size:0.8rem; color:gray;">Excelencia Azul</div>
                </div>
                <div class="list-item">
                    <div>üèÖ Green Logistics</div>
                    <div style="font-size:0.8rem; color:gray;">Compromiso 15d</div>
                </div>
            </div>

        </div>
    </div>

</div>

<script>
    // 1. CONEXI√ìN SUPABASE
    const SB_URL = 'https://ophicpcbgdgzthjamzoz.supabase.co';
    const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9waGljcGNiZ2RnenRoamFtem96Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ3MjgwMzUsImV4cCI6MjA4MDMwNDAzNX0.K55Tk-cdbAFDOtGrIMN7vYFaJAccrsD6UdOrARt1P5c';
    const supabase = window.supabase.createClient(SB_URL, SB_KEY);

    // 2. INICIAR SISTEMA
    initDashboard();

    async function initDashboard() {
        console.log("Iniciando Dashboard...");
        
        // A. Obtener Total de Firmas Reales
        const { count, data: ultimos, error } = await supabase
            .from('firmantes')
            .select('*', { count: 'exact' })
            .order('fecha_firma', { ascending: false })
            .limit(5);

        if(!error) {
            actualizarKPIs(count, ultimos);
            renderChart(count);
        }
        
        animarMapa();
    }

    function actualizarKPIs(totalFirmas, ultimos) {
        // 1. KPI Principal
        document.getElementById('kpi-pactos').textContent = totalFirmas.toLocaleString();

        // 2. Calcular Impacto (L√≥gica Proyectada)
        // Asumimos: 1 Firma = 7500kg CO2, 290kg Plastico, 11500L Agua (Promedio anual)
        let co2 = (totalFirmas * 7500 + 8500000).toLocaleString(); // Base hist√≥rica + Real
        let plastico = (totalFirmas * 290 + 320000).toLocaleString();
        let agua = (totalFirmas * 11500 + 12000000).toLocaleString();

        document.getElementById('impacto-ambiental').innerHTML = 
            `üå± IMPACTO ACUMULADO: ${co2} kg CO‚ÇÇ evitados ‚Ä¢ ${plastico} kg pl√°stico ‚Ä¢ ${agua} L agua`;

        // 3. Lista de √öltimos Guardianes (Muro Lateral)
        const lista = document.getElementById('lista-guardianes');
        let html = '';
        ultimos.forEach(u => {
            let fecha = new Date(u.fecha_firma).toLocaleDateString();
            html += `
                <div class="list-item">
                    <div>
                        <div style="font-weight:bold; color:#fff;">${u.nombre}</div>
                        <div style="font-size:0.75rem; color:var(--accent);">${u.codigo_usado}</div>
                    </div>
                    <div style="font-size:0.8rem; color:gray;">${fecha}</div>
                </div>`;
        });
        lista.innerHTML = html;
    }

    // 3. GR√ÅFICA REAL (Chart.js)
    function renderChart(totalActual) {
        const ctx = document.getElementById('chartImpacto').getContext('2d');
        
        // Datos simulados de meses anteriores + El mes actual REAL
        const data = {
            labels: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul'],
            datasets: [{
                label: 'Crecimiento de Pactos',
                data: [120, 190, 300, 500, 800, 1000, 1000 + totalActual], // Sumamos los reales al final
                borderColor: '#00c4ff',
                backgroundColor: 'rgba(0, 196, 255, 0.1)',
                fill: true,
                tension: 0.4
            }]
        };

        new Chart(ctx, {
            type: 'line',
            data: data,
            options: {
                responsive: true,
                plugins: { legend: { display: false } },
                scales: {
                    y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#8fb3c4' } },
                    x: { grid: { display: false }, ticks: { color: '#8fb3c4' } }
                }
            }
        });
    }

    // 4. ANIMACI√ìN MAPA
    function animarMapa() {
        const mapa = document.getElementById('mapa');
        for(let i=0; i<10; i++) {
            let dot = document.createElement('div');
            dot.className = 'dot';
            dot.style.left = Math.random() * 90 + '%';
            dot.style.top = Math.random() * 80 + 10 + '%';
            dot.style.animationDelay = Math.random() * 2 + 's';
            mapa.appendChild(dot);
        }
    }
</script>

</body>
</html>
