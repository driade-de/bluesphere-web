<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Global BlueSphere - Real</title>
    
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <style>
        /* --- ESTILOS ORIGINALES (MANTENIDOS) --- */
        :root {
            --bg: #041016; --card: #07212a; --accent: #4fc3f7;
            --success: #4caf50; --warning: #ff9800; --danger: #f44336;
            --white: #ffffff; --muted: #c8eaff;
        }
        body { margin: 0; padding: 0; background: var(--bg); color: var(--white); font-family: 'Arial', sans-serif; }
        .dashboard-container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        
        .header { text-align: center; padding: 30px 0; background: linear-gradient(135deg, var(--card), #083542); border-radius: 15px; margin-bottom: 30px; border: 2px solid var(--accent); }
        
        .metricas-principales { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .metrica-card { background: var(--card); padding: 25px; border-radius: 15px; border: 1px solid var(--accent); text-align: center; transition: transform 0.3s ease; }
        .metrica-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(79, 195, 247, 0.2); }
        .valor-metrica { font-size: 2.5rem; font-weight: bold; margin: 15px 0; background: linear-gradient(135deg, var(--accent), #81d4fa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        .grid-dashboard { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 30px; }
        .seccion-graficos, .leaderboard { background: var(--card); padding: 25px; border-radius: 15px; border: 1px solid var(--accent); }
        
        /* Ajuste para lista real */
        .empresa-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .ranking-badge { background: var(--accent); color: var(--bg); padding: 5px 10px; border-radius: 20px; font-weight: bold; font-size: 0.8rem; }
        
        .impacto-acumulado { font-size: 1.2rem; text-align: center; margin: 30px 0; padding: 20px; background: linear-gradient(135deg, rgba(76, 175, 80, 0.2), rgba(79, 195, 247, 0.1)); border-radius: 15px; border: 1px solid var(--success); }
        
        .actualizacion-tiempo-real { position: fixed; top: 20px; right: 20px; background: var(--success); color: var(--bg); padding: 8px 15px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        /* Utilidades */
        .small { font-size: 0.8rem; color: var(--muted); }
        .loading { color: var(--accent); font-style: italic; }
    </style>
</head>
<body>
    <div class="actualizacion-tiempo-real">‚óè Conectado a Supabase</div>
    
    <div class="dashboard-container">
        <div class="header">
            <h1>üåç DASHBOARD GLOBAL BLUESPHERE</h1>
            <p>Datos reales extra√≠dos de la base de datos central</p>
        </div>
        
        <div class="metricas-principales">
            
            <div class="metrica-card">
                <h3>üåä Guardianes Activos</h3>
                <div class="valor-metrica" id="total-firmas">
                    <span class="loading">Cargando...</span>
                </div>
                <div class="small">Firmas en el Pacto Azul</div>
            </div>
            
            <div class="metrica-card">
                <h3>üå± CO‚ÇÇ Proyectado</h3>
                <div class="valor-metrica" id="total-co2">
                    <span class="loading">...</span>
                </div>
                <div class="small">kg evitados (Estimaci√≥n)</div>
            </div>
            
            <div class="metrica-card">
                <h3>üîë C√≥digos Libres</h3>
                <div class="valor-metrica" id="codigos-libres">
                    <span class="loading">...</span>
                </div>
                <div class="small">Disponibles para donantes</div>
            </div>
            
            <div class="metrica-card">
                <h3>üåç Alcance Global</h3>
                <div class="valor-metrica" id="total-paises">
                    <span class="loading">...</span>
                </div>
                <div class="small">Pa√≠ses/Ciudades distintos</div>
            </div>
        </div>
        
        <div class="impacto-acumulado">
            <strong>ESTADO DEL SISTEMA:</strong> 
            El Pacto Azul est√° activo. Cada firma representa un compromiso real con el futuro.
        </div>
        
        <div class="grid-dashboard">
            <div class="seccion-graficos">
                <h3>üìä Crecimiento de la Comunidad</h3>
                <div style="height: 300px; display:flex; align-items:center; justify-content:center; color:var(--muted); background:rgba(255,255,255,0.02); border-radius:10px;">
                    <p>(Gr√°fico se activar√° al superar 100 firmas)</p>
                </div>
            </div>
            
            <div class="leaderboard">
                <h3>üèÖ √öltimos Guardianes</h3>
                <div id="lista-recientes">
                    <p class="loading">Consultando base de datos...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 1. CONFIGURACI√ìN SUPABASE
        const SB_URL = 'https://ophicpcbgdgzthjamzoz.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9waGljcGNiZ2RnenRoamFtem96Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ3MjgwMzUsImV4cCI6MjA4MDMwNDAzNX0.K55Tk-cdbAFDOtGrIMN7vYFaJAccrsD6UdOrARt1P5c';
        
        let supabase;

        // 2. INICIAR DASHBOARD
        window.onload = async function() {
            try {
                // Iniciar cliente
                supabase = window.supabase.createClient(SB_URL, SB_KEY);
                console.log("Dashboard conectado a DB Real.");
                
                // Cargar datos
                await cargarMetricas();
                await cargarRecientes();

                // Actualizar cada 30 segundos autom√°ticamente
                setInterval(() => {
                    cargarMetricas();
                    cargarRecientes();
                }, 30000);

            } catch (e) {
                console.error("Error iniciando dashboard:", e);
            }
        };

        // 3. CARGAR M√âTRICAS (CONTEOS)
        async function cargarMetricas() {
            // A. Contar Firmas
            const { count: firmasCount, error: errorFirmas } = await supabase
                .from('firmantes')
                .select('*', { count: 'exact', head: true });

            if (!errorFirmas) {
                const total = firmasCount || 0;
                // Animaci√≥n simple de n√∫mero
                document.getElementById('total-firmas').textContent = total.toLocaleString();
                
                // C√°lculo de impacto (Ejemplo: 1 Firma = 50kg CO2 simb√≥lico)
                const co2 = total * 50; 
                document.getElementById('total-co2').textContent = co2.toLocaleString();
            }

            // B. Contar C√≥digos Disponibles (usado = false)
            const { count: codigosCount, error: errorCodigos } = await supabase
                .from('codigos')
                .select('*', { count: 'exact', head: true })
                .eq('usado', false); // Solo los no usados

            if (!errorCodigos) {
                document.getElementById('codigos-libres').textContent = (codigosCount || 0).toLocaleString();
            }

            // C. Contar Pa√≠ses (Aproximaci√≥n simple contando filas con pa√≠s)
            // (Para un count distinct real se requiere una query m√°s compleja, aqu√≠ usamos una aprox)
            const { data: paisesData } = await supabase
                .from('firmantes')
                .select('pais')
                .not('pais', 'is', null);
            
            if(paisesData) {
                // Filtrar √∫nicos en JS
                const unicos = new Set(paisesData.map(p => p.pais.toUpperCase().trim()));
                document.getElementById('total-paises').textContent = unicos.size;
            }
        }

        // 4. CARGAR LISTA RECIENTE (Muro Lateral)
        async function cargarRecientes() {
            const lista = document.getElementById('lista-recientes');
            
            const { data, error } = await supabase
                .from('firmantes')
                .select('nombre, fecha_firma, pais')
                .order('fecha_firma', { ascending: false })
                .limit(5);

            if (error) {
                lista.innerHTML = "Error al cargar.";
                return;
            }

            if (!data || data.length === 0) {
                lista.innerHTML = "<div style='padding:20px; text-align:center; color:#888'>Esperando la primera firma...</div>";
                return;
            }

            let html = "";
            data.forEach((item, index) => {
                // Formatear fecha
                const fecha = new Date(item.fecha_firma).toLocaleDateString();
                const pais = item.pais || "Global";
                
                html += `
                <div class="empresa-item">
                    <div>
                        <span class="ranking-badge">#${index + 1}</span>
                        <strong>${escapeHtml(item.nombre)}</strong>
                        <div style="font-size:0.8rem; color:#4fc3f7">${escapeHtml(pais)}</div>
                    </div>
                    <div style="font-size:0.8rem; color:#aaa; text-align:right">
                        ${fecha}<br>
                        <span style="color:#4caf50">Activo</span>
                    </div>
                </div>`;
            });
            lista.innerHTML = html;
        }

        // Seguridad para textos
        function escapeHtml(text) {
            if (!text) return "";
            return text.replace(/[&<>"']/g, function(m) {
                return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' }[m];
            });
        }
    </script>
</body>
</html>
