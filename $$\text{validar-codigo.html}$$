<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Validar Código – BlueSphere</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>

<h1>Validación de Código – BlueSphere</h1>

<p>Ingresa tu código BlueSphere para continuar:</p>

<input type="text" id="codigo" placeholder="Ejemplo: GPR-AQUA-XXXX" style="padding:10px; width:260px">
<button id="btnValidar">Validar</button>

<p id="mensaje" style="margin-top:20px; font-weight:bold;"></p>

<script type="module">
import { supabase } from './supabase-config.js';

const input = document.getElementById("codigo");
const btn = document.getElementById("btnValidar");
const mensaje = document.getElementById("mensaje");

btn.addEventListener("click", async () => {
    const cod = input.value.trim();

    if (cod === "") {
        mensaje.innerText = "Por favor ingresa un código.";
        mensaje.style.color = "red";
        return;
    }

    // Buscar el código en Supabase
    const { data, error } = await supabase
        .from('codigos')
        .select('*')
        .eq('codigo', cod)
        .single();

    if (error || !data) {
        mensaje.innerText = "✖ Código inválido.";
        mensaje.style.color = "red";
        return;
    }

    if (data.usado) {
        mensaje.innerText = "✖ Este código ya fue usado.";
        mensaje.style.color = "orange";
        return;
    }

    // Marcar código como usado
    await supabase
        .from('codigos')
        .update({ usado: true })
        .eq('id', data.id);

    // Guardar registro en guardianes
    await supabase
        .from('guardianes')
        .insert([{ nombre: "Nombre del guardián", codigo: cod }]);

    mensaje.innerText = "✓ Código válido. Redirigiendo al certificado...";
    mensaje.style.color = "green";

    // Guardar código en sessionStorage para usarlo en certificado-bluesphere.html
    sessionStorage.setItem('codigoValidado', cod);

    setTimeout(() => {
        window.location.href = "certificado-bluesphere.html";
    }, 1500);
});
</script>

</body>
</html>
