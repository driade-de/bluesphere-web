<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Portal del Pacto Azul ‚Äî Ritual Sagrado</title>
<meta name="description" content="Portal del Pacto Azul ‚Äî Ritual sagrado para inscribir nombres en el Registro Azul Hist√≥rico."/>
<style>
:root{
  --bg:#010912;
  --card: rgba(6,30,40,0.55);
  --glow:#00c4ff;
  --light:#8feaff;
  --muted:#b7e9ff;
  --accent-dark:#002731;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  background: radial-gradient(circle at 15% 10%, rgba(0,120,180,0.06), transparent), radial-gradient(circle at 85% 80%, rgba(0,40,90,0.06), transparent), var(--bg);
  color:#eaffff; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  overflow-x:hidden;
}
/* (Mantener todos los estilos previos igual, incluyendo canvas, overlay, header, layout, grid, inputs, result-box, firma, seal, muro, ritual overlay, audio y footer) */
</style>
</head>
<body>

<canvas id="bgCanvas" aria-hidden="true"></canvas>
<div class="water-overlay" aria-hidden="true"></div>

<header>
  <div class="title">El Pacto Azul</div>
  <div class="subtitle">Ritual Sagrado ‚Äî Inscribe tu nombre en el Registro Azul Hist√≥rico</div>
</header>

<main class="wrap" role="main" aria-labelledby="main-title">

  <section class="card" id="introCard">
    <h2 id="main-title">üåä El Llamado</h2>
    <p class="small">Firmar el Pacto Azul es un acto de conciencia. Cuando escribes tu nombre, declaras que ser√°s Guardi√°n. Hazlo con intenci√≥n. Conserva tu c√≥digo seguro.</p>
  </section>

  <section class="grid">

    <!-- Left: ritual -->
    <div class="card" aria-labelledby="accesoTitle">
      <h2 id="accesoTitle">üîë Acceso Sagrado</h2>
      <p class="small">Introduce el c√≥digo que recibiste como donante o inversor. Solo c√≥digos autorizados pueden activar la firma ritual.</p>

      <div class="center" style="margin-top:14px">
        <input id="codigoInput" class="input" type="text" placeholder="Ej: BS-PZ-2026-000123-AZUL" aria-label="C√≥digo del Pacto Azul">
        <div style="margin-top:10px">
          <button class="btn" onclick="validarCodigo()">Validar C√≥digo</button>
          <button class="btn-ghost" onclick="openHelp()">¬øNo tienes c√≥digo?</button>
        </div>
        <div id="resultado" class="result-box hidden" role="status" aria-live="polite"></div>
      </div>

      <!-- Firma -->
      <div id="firmaBox" class="fade-in hidden" style="margin-top:16px">
        <h3 class="small">‚úçÔ∏è Firma el Pacto</h3>
        <p class="small">Escribe tu nombre exactamente como quieres que aparezca en el Registro Azul Hist√≥rico.</p>
        <div class="firma-area">
          <input id="nombreInput" class="input" type="text" placeholder="Tu nombre completo ‚Äî Ej: Ana L√≥pez (M√©xico)">
          <div id="nameTrace" aria-hidden="true"></div>
          <div style="margin-top:8px">
            <button class="btn" onclick="startRitual()">Firmar Pacto Azul</button>
            <button class="btn-ghost" onclick="cancelarFirma()">Cancelar</button>
          </div>
        </div>

        <div class="small" style="margin-top:10px">Puedes activar la m√∫sica ambiental para una experiencia completa (opcional).</div>
        <div style="margin-top:8px" class="audio-bar">
          <button id="audioToggle" class="btn-ghost" onclick="toggleAudio()">üîä M√∫sica ambiental: OFF</button>
        </div>
      </div>

      <!-- seal preview -->
      <div id="seal" class="hidden" aria-hidden="true">
        <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <defs>
            <linearGradient id="g1" x1="0" x2="1">
              <stop offset="0" stop-color="#7ef3ff"/>
              <stop offset="1" stop-color="#00bcd4"/>
            </linearGradient>
          </defs>
          <circle cx="50" cy="50" r="46" fill="none" stroke="url(#g1)" stroke-width="2.8"/>
          <path d="M20 62 C36 44, 64 44, 80 62" fill="none" stroke="url(#g1)" stroke-width="3.4" stroke-linecap="round"/>
          <circle cx="34" cy="38" r="2.8" fill="#7ef3ff"/>
          <circle cx="66" cy="38" r="2.8" fill="#7ef3ff"/>
        </svg>
      </div>

    </div>

    <!-- Right: muro -->
    <aside class="muroside card" aria-labelledby="muroTitle">
      <h2 id="muroTitle">üåê Muro del Pacto Azul</h2>
      <p class="small">Los nombres que sostienen el despertar de la conciencia planetaria. Tu firma aparecer√° aqu√≠ cuando se confirme.</p>

      <div id="muro" class="name-list" aria-live="polite"></div>

      <div style="margin-top:14px; text-align:center">
        <button class="btn-ghost" onclick="verTodos()">Ver listado completo</button>
        <button class="btn" onclick="exportNames()">üì§ Exportar (admin)</button>
      </div>
    </aside>

  </section>

  <!-- accesos tras firma -->
  <section id="accesosBox" class="card hidden" aria-hidden="true" style="text-align:center">
    <h2>üéâ Bienvenido, Guardi√°n del Pacto Azul</h2>
    <p class="small">Tu firma ha sido registrada. Accede a tus recursos y comparte tu pertenencia al Pacto.</p>
    <div style="display:flex; gap:12px; flex-wrap:wrap; justify-content:center; margin-top:12px">
      <a class="btn" href="certificado-bluesphere.html" target="_blank" rel="noopener">üìú Descargar Certificado</a>
      <a class="btn" href="modulo-biblioteca.html" target="_blank" rel="noopener">üìö Biblioteca</a>
      <a class="btn" href="modulo-seguimiento.html" target="_blank" rel="noopener">üîÅ Seguimiento</a>
      <a class="btn" href="dashboard-global-impacto.html" target="_blank" rel="noopener">üåç Dashboard</a>
    </div>
  </section>

</main>

<!-- audio y ritual overlay (igual que antes) -->

<!-- Librer√≠a Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>

<script>
// Inicializaci√≥n Supabase
const SUPABASE_URL = 'https://ophicpcbgdgzthjamzoz.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9waGljcGNiZ2RnenRoamtem96Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ3MjgwMzUsImV4cCI6MjA4MDMwNDAzNX0.K55Tk-cdbAFDOtGrIMN7vYFaJAccrsD6UdOrARt1P5c';
const supabase = Supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let firmantes = [];
const muroEl = document.getElementById('muro');

// Funci√≥n para mostrar muro
async function renderMuro(){
  const { data, error } = await supabase.from('firmantes').select('nombre').order('id', {ascending:false});
  if(error){ console.error(error); return; }
  firmantes = data.map(d=>d.nombre);
  if(firmantes.length===0){
    muroEl.innerHTML = '<div style="color:var(--muted); font-style:italic">A√∫n no hay firmas p√∫blicas. S√© el primero en firmar el Pacto Azul.</div>';
    return;
  }
  muroEl.innerHTML = firmantes.map(name=>`<div class="name-item"><span class="name-glow">${escapeHtml(name)}</span></div>`).join('');
}
renderMuro();

// Validaci√≥n c√≥digo contra Supabase
async function validarCodigo(){
  const code = document.getElementById('codigoInput').value.trim();
  const res = document.getElementById('resultado');
  if(!code){ res.className='result-box'; res.innerHTML='<div class="fail">‚ö† Ingresa tu c√≥digo.</div>'; res.classList.remove('hidden'); return; }
  
  const { data, error } = await supabase.from('codigos').select('*').eq('codigo', code).single();
  if(error || !data){
    res.className='result-box'; res.innerHTML='<div class="fail">‚ùå C√≥digo no reconocido. Contacta soporte.</div>'; res.classList.remove('hidden');
    return;
  }

  // C√≥digo v√°lido, mostrar firma
  res.className='result-box'; res.innerHTML='<div class="ok">‚úî C√≥digo autorizado. Procede a la firma ritual.</div>'; res.classList.remove('hidden');
  document.getElementById('firmaBox').classList.remove('hidden');
}

// Insertar firma
async function startRitual(){
  const nombre = document.getElementById('nombreInput').value.trim();
  const code = document.getElementById('codigoInput').value.trim();
  if(!nombre){ alert('Ingresa tu nombre para firmar el Pacto.'); return; }

  const { data, error } = await supabase.from('firmantes').insert([{ nombre, codigo_usado: code, fecha_firma: new Date().toISOString() }]);
  if(error){ alert('Error al registrar tu firma.'); console.error(error); return; }

  renderMuro();
  document.getElementById('accesosBox').classList.remove('hidden');
  document.getElementById('resultado').innerHTML='<div class="ok">‚úÖ Tu firma ha sido registrada en el Pacto Azul.</div>';
  document.getElementById('firmaBox').classList.add('hidden');
}

// Helpers
function escapeHtml(s){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
function cancelarFirma(){ document.getElementById('firmaBox').classList.add('hidden'); }
function verTodos(){ alert('Funci√≥n: ver listado completo (admin).'); }
function exportNames(){ alert('Funci√≥n: exportar CSV (admin).'); }

// Accessibility: enter
document.getElementById('codigoInput').addEventListener('keydown', e=>{ if(e.key==='Enter') validarCodigo(); });
document.getElementById('nombreInput').addEventListener('keydown', e=>{ if(e.key==='Enter') startRitual(); });
</script>

</body>
</html>


