<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Portal del Pacto Azul ‚Äî Ritual Sagrado</title>
<style>
/* --- EST√âTICA VISUAL (Ghibli/Dark) --- */
:root{ --bg:#010912; --card: rgba(6,30,40,0.65); --glow:#00c4ff; --light:#8feaff; --muted:#b7e9ff; --accent-dark:#002731; }
*{box-sizing:border-box}
html,body{height:100%}
body{ margin:0; font-family:Inter, system-ui, sans-serif; background: radial-gradient(circle at 15% 10%, rgba(0,120,180,0.06), transparent), radial-gradient(circle at 85% 80%, rgba(0,40,90,0.06), transparent), var(--bg); color:#eaffff; overflow-x:hidden; }

/* Efectos de Fondo */
#bgCanvas{position:fixed; inset:0; z-index:0; pointer-events:none}
.water-overlay{position:fixed; inset:0; z-index:0; pointer-events:none; mix-blend-mode:screen; opacity:0.95}
.water-overlay::before{content:""; position:absolute; inset:0; background: radial-gradient(circle at 30% 20%, rgba(0,120,180,0.05), transparent 10%), radial-gradient(circle at 80% 80%, rgba(0,60,140,0.05), transparent 15%); transform: translateY(0); animation: drift 18s linear infinite}
@keyframes drift{0%{transform:translateY(0)}50%{transform:translateY(-12px)}100%{transform:translateY(0)}}

/* Layout */
header{position:relative; z-index:2; padding:36px 20px 6px; text-align:center}
.title{font-size:2.4rem; color:var(--glow); font-weight:900; letter-spacing:1px; text-shadow:0 0 18px rgba(0,180,255,0.18)}
.subtitle{color:var(--muted); margin-top:6px}
.wrap{position:relative; z-index:2; max-width:1100px; margin:28px auto 80px; padding:24px}
.card{background:var(--card); border-radius:16px; padding:24px; margin-bottom:20px; border:1px solid rgba(255,255,255,0.08); box-shadow:0 12px 40px rgba(0,10,20,0.6); backdrop-filter: blur(8px)}
.grid{display:grid; grid-template-columns:1fr 420px; gap:20px; align-items:start}
@media(max-width:920px){ .grid{grid-template-columns:1fr} }

/* UI Elements */
.center{text-align:center}
.input{width:100%; padding:14px; border-radius:10px; border:1px solid rgba(0,196,255,0.3); background:rgba(2,26,34,0.6); color:#fff; font-size:1rem; outline:none; margin-top:8px; display:block;}
.input:focus{border-color:var(--glow); box-shadow:0 0 10px rgba(0,196,255,0.2)}
.btn{display:block; width:100%; margin-top:18px; padding:14px; border-radius:10px; font-weight:800; background:linear-gradient(135deg,var(--glow),var(--light)); color:var(--accent-dark); border:none; cursor:pointer; box-shadow:0 0 20px rgba(0,196,255,0.2); transition:transform 0.2s}
.btn:hover{transform:scale(1.02); filter:brightness(1.1)}
.btn-ghost{background:transparent; border:1px solid rgba(255,255,255,0.2); color:var(--muted); padding:10px; width:100%; margin-top:10px; border-radius:10px; cursor:pointer}

/* Feedback & Muro */
.result-box{margin-top:16px; padding:14px; border-radius:12px; text-align:center; font-weight:bold}
.ok{background:rgba(0,50,60,0.6); color:#9effd8; border:1px solid #9effd8}
.fail{background:rgba(50,10,10,0.6); color:#ff9b9b; border:1px solid #ff9b9b}
.hidden{display:none !important}

/* Muro */
.muroside{max-height:500px; overflow-y:auto}
.name-item{padding:12px; margin:8px 0; border-radius:8px; background:linear-gradient(90deg, rgba(0,200,255,0.05), transparent); border-bottom:1px solid rgba(255,255,255,0.05); animation:fadeIn 0.5s ease}
.name-glow{color:var(--light); font-weight:bold; font-size:1.1rem}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}

/* Overlay */
#ritualOverlay{position:fixed; inset:0; z-index:99; background:radial-gradient(circle, rgba(0,10,20,0.95), black); display:none; align-items:center; justify-content:center; flex-direction:column}
</style>
</head>
<body>

<canvas id="bgCanvas"></canvas>
<div class="water-overlay"></div>

<header>
  <div class="title">El Pacto Azul</div>
  <div class="subtitle">Ritual Sagrado ‚Äî Inscribe tu nombre en el Registro Azul Hist√≥rico</div>
</header>

<main class="wrap">
  <section class="grid">
    
    <div class="card">
      <h2 class="center" style="color:var(--glow)">üîë Acceso Sagrado</h2>
      
      <div id="faseCodigo">
        <p class="center" style="color:var(--muted)">Introduce tu c√≥digo de Guardi√°n para abrir el portal.</p>
        <input id="codigoInput" class="input" type="text" placeholder="Ej: GPR-AQUA-0021">
        <button class="btn" onclick="validarCodigo()">Validar C√≥digo</button>
        <div id="resultado" class="result-box hidden"></div>
      </div>

      <div id="faseFirma" class="hidden">
        <h3 class="center" style="color:var(--light)">‚úçÔ∏è Firma el Pacto</h3>
        <p class="center" style="color:var(--muted); font-size:0.9rem">Tu nombre ser√° sellado para siempre.</p>
        
        <input id="nombreInput" class="input" type="text" placeholder="Tu Nombre Completo *">
        <input id="paisInput" class="input" type="text" placeholder="Pa√≠s / Ciudad (Opcional)">
        <input id="notaInput" class="input" type="text" placeholder="Mensaje para el futuro (Opcional)">
        
        <button class="btn" onclick="startRitual()">SELLAR FIRMA</button>
        <button class="btn-ghost" onclick="cancelarFirma()">Cancelar</button>
      </div>

      <div id="seal" class="hidden center" style="margin-top:20px">
        <svg width="100" height="100" viewBox="0 0 100 100" style="filter:drop-shadow(0 0 10px #00c4ff)">
            <circle cx="50" cy="50" r="45" fill="none" stroke="#00c4ff" stroke-width="2"/>
            <path d="M30 50 Q50 20 70 50 T30 50" fill="none" stroke="#8feaff" stroke-width="2"/>
        </svg>
        <p style="color:#00c4ff; font-weight:bold">REGISTRO COMPLETADO</p>
      </div>
    </div>

    <aside class="card muroside">
      <h2 class="center" style="color:var(--glow)">üåê Muro del Pacto</h2>
      <div id="muro">
        <div class="center" style="padding:20px; color:var(--muted)">Conectando...</div>
      </div>
      <button class="btn-ghost" onclick="cargarMuro()">‚Üª Actualizar Lista</button>
    </aside>

  </section>

  <section id="accesosBox" class="card hidden center" style="max-width:800px; margin:20px auto;">
    <h2>üéâ ¬°Bienvenido Guardi√°n!</h2>
    <p style="color:var(--muted); margin-bottom: 20px;">Tu firma ha sido sellada. Ahora tienes acceso total al ecosistema BlueSphere.</p>
    
    <div style="display:flex; gap:15px; justify-content:center; flex-wrap: wrap;">
       <a id="btnCertificado" href="certificado-bluesphere.html" target="_blank" class="btn" style="width:auto; text-decoration:none; min-width:160px; display:inline-block;">
    üìú Descargar Certificado
</a>
        
        <a href="#" class="btn" style="width:auto; text-decoration:none; min-width:160px;" onclick="alert('Accediendo a Biblioteca...')">
            üìö Biblioteca
        </a>

        <a href="#" class="btn" style="width:auto; text-decoration:none; min-width:160px;" onclick="alert('Ver m√≥dulo de seguimiento...')">
            üîÅ Seguimiento
        </a>

        <a href="#" class="btn" style="width:auto; text-decoration:none; min-width:160px;" onclick="alert('Abriendo Dashboard Global...')">
            üåç Dashboard
        </a>
    </div>
  </section>
</main>

<div id="ritualOverlay">
    <h2 style="color:var(--glow); font-size:2rem">Procesando...</h2>
    <p style="color:var(--muted)">Consultando la base de datos</p>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

// CONFIGURACI√ìN SUPABASE
const SUPABASE_URL = 'https://ophicpcbgdgzthjamzoz.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9waGljcGNiZ2RnenRoamFtem96Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ3MjgwMzUsImV4cCI6MjA4MDMwNDAzNX0.K55Tk-cdbAFDOtGrIMN7vYFaJAccrsD6UdOrARt1P5c';
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// ELEMENTOS DOM
const muroEl = document.getElementById('muro');
const resultadoEl = document.getElementById('resultado');
const faseCodigo = document.getElementById('faseCodigo');
const faseFirma = document.getElementById('faseFirma');
const seal = document.getElementById('seal');
const accesosBox = document.getElementById('accesosBox');
const ritualOverlay = document.getElementById('ritualOverlay');

let codigoValidado = false;

// 1. VALIDAR C√ìDIGO (Real vs DB)
async function validarCodigo() {
    const codigo = document.getElementById('codigoInput').value.trim();
    if(!codigo) return mostrarError('Ingresa un c√≥digo');

    mostrarCarga(true, "Verificando c√≥digo...");

    // Consultar tabla 'codigos'
    const { data, error } = await supabase
        .from('codigos')
        .select('*')
        .eq('codigo', codigo)
        .single();

    mostrarCarga(false);

    if (error || !data) {
        mostrarError('‚ùå C√≥digo no v√°lido o no encontrado.');
        codigoValidado = false;
    } else {
        // C√≥digo existe en la DB
        resultadoEl.className = 'hidden';
        faseCodigo.classList.add('hidden');
        faseFirma.classList.remove('hidden');
        codigoValidado = true;
    }
}

// 2. FIRMAR (Insertar en 'firmantes')
async function startRitual() {
    if(!codigoValidado) return alert('Error de validaci√≥n');
    
    const nombre = document.getElementById('nombreInput').value.trim();
    const codigo = document.getElementById('codigoInput').value.trim();
    const pais = document.getElementById('paisInput').value.trim();
    const nota = document.getElementById('notaInput').value.trim();

    if(!nombre) return alert('El nombre es obligatorio');

    mostrarCarga(true, "Sellando firma...");

    // Insertar en tabla 'firmantes'
    const { error } = await supabase
        .from('firmantes')
        .insert([{ 
            nombre: nombre, 
            codigo_usado: codigo,
            pais: pais,
            nota: nota
        }]);

    mostrarCarga(false);

    if (error) {
        alert('Error al guardar: ' + error.message);
    } else {
    // 1. √âxito visual (Esto ya estaba)
    faseFirma.classList.add('hidden');
    seal.classList.remove('hidden');
    accesosBox.classList.remove('hidden');
    cargarMuro(); 

    // 2. LO NUEVO: Configurar el bot√≥n del certificado
    const btnCert = document.getElementById('btnCertificado');
    if (btnCert) {
        // Aqu√≠ le pegamos tu nombre y c√≥digo para que viajen al certificado
        btnCert.href = `certificado-bluesphere.html?nombre=${encodeURIComponent(nombre)}&codigo=${encodeURIComponent(codigo)}`;
    }
}

// 3. CARGAR MURO
async function cargarMuro() {
    muroEl.innerHTML = '<div class="center" style="color:var(--muted)">Actualizando...</div>';
    
    const { data, error } = await supabase
        .from('firmantes')
        .select('nombre')
        .order('fecha_firma', { ascending: false })
        .limit(20);

    if (data) {
        if(data.length === 0) {
            muroEl.innerHTML = '<div class="center" style="color:var(--muted)">S√© el primero en firmar.</div>';
        } else {
            muroEl.innerHTML = '';
            data.forEach(item => {
                const div = document.createElement('div');
                div.className = 'name-item name-glow';
                div.textContent = item.nombre; // Nombre real de la DB
                muroEl.appendChild(div);
            });
        }
    } else {
        console.error(error);
        muroEl.innerHTML = '<div class="center fail">Error de conexi√≥n</div>';
    }
}

// UTILS
function mostrarError(msg) {
    resultadoEl.textContent = msg;
    resultadoEl.className = 'result-box fail';
    resultadoEl.classList.remove('hidden');
}
function mostrarCarga(show, msg) {
    ritualOverlay.style.display = show ? 'flex' : 'none';
    if(msg) ritualOverlay.querySelector('h2').textContent = msg;
}
function cancelarFirma() {
    faseFirma.classList.add('hidden');
    faseCodigo.classList.remove('hidden');
    resultadoEl.classList.add('hidden');
}

// INICIALIZAR
cargarMuro();

// FONDO ANIMADO
const canvas = document.getElementById('bgCanvas');
const ctx = canvas.getContext('2d');
let w, h, stars=[];
function initStars(){
    w = canvas.width = innerWidth; 
    h = canvas.height = innerHeight;
    stars=[];
    for(let i=0; i<80; i++) stars.push({x:Math.random()*w, y:Math.random()*h, s:Math.random()*0.5});
}
initStars();
function draw(){
    ctx.clearRect(0,0,w,h);
    ctx.fillStyle="#8feaff";
    stars.forEach(p=>{ 
        p.y-=p.s; if(p.y<0)p.y=h; 
        ctx.beginPath(); ctx.arc(p.x,p.y,Math.random()*2,0,Math.PI*2); ctx.fill(); 
    });
    requestAnimationFrame(draw);
}
draw();
window.addEventListener('resize', initStars);

// --- EXPOSICI√ìN DE FUNCIONES (ESTO ARREGLA LOS BOTONES) ---
window.validarCodigo = validarCodigo;
window.startRitual = startRitual;
window.cancelarFirma = cancelarFirma;
window.cargarMuro = cargarMuro;
window.openHelp = () => alert('Contacta soporte.');
window.exportNames = () => alert('Funci√≥n Admin.');
window.verTodos = cargarMuro;

</script>
</body>
</html>
