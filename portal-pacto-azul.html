<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Portal del Pacto Azul ‚Äî Ritual Sagrado</title>
<style>
/* --- EST√âTICA VISUAL (Ghibli/Dark) --- */
:root{ --bg:#010912; --card: rgba(6,30,40,0.65); --glow:#00c4ff; --light:#8feaff; --muted:#b7e9ff; --accent-dark:#002731; }
*{box-sizing:border-box}
html,body{height:100%}
body{ margin:0; font-family:Inter, system-ui, sans-serif; background: radial-gradient(circle at 15% 10%, rgba(0,120,180,0.06), transparent), radial-gradient(circle at 85% 80%, rgba(0,40,90,0.06), transparent), var(--bg); color:#eaffff; overflow-x:hidden; }

/* Efectos de Fondo */
#bgCanvas{position:fixed; inset:0; z-index:0; pointer-events:none}
.water-overlay{position:fixed; inset:0; z-index:0; pointer-events:none; mix-blend-mode:screen; opacity:0.95}
.water-overlay::before{content:""; position:absolute; inset:0; background: radial-gradient(circle at 30% 20%, rgba(0,120,180,0.05), transparent 10%), radial-gradient(circle at 80% 80%, rgba(0,60,140,0.05), transparent 15%); transform: translateY(0); animation: drift 18s linear infinite}
@keyframes drift{0%{transform:translateY(0)}50%{transform:translateY(-12px)}100%{transform:translateY(0)}}

/* Layout OPTIMIZADO */
header{position:relative; z-index:2; padding:20px 20px 10px; text-align:center}
.title{font-size:2.4rem; color:var(--glow); font-weight:900; letter-spacing:1px; text-shadow:0 0 18px rgba(0,180,255,0.18)}
.subtitle{color:var(--muted); margin-top:6px}
.wrap{position:relative; z-index:2; max-width:1100px; margin:15px auto 40px; padding:20px}
.card{background:var(--card); border-radius:16px; padding:24px; margin-bottom:20px; border:1px solid rgba(255,255,255,0.08); box-shadow:0 12px 40px rgba(0,10,20,0.6); backdrop-filter: blur(8px)}
.grid{display:grid; grid-template-columns:1fr 420px; gap:20px; align-items:start}
@media(max-width:920px){ .grid{grid-template-columns:1fr} }

/* UI Elements */
.center{text-align:center}
.input{width:100%; padding:14px; border-radius:10px; border:1px solid rgba(0,196,255,0.3); background:rgba(2,26,34,0.6); color:#fff; font-size:1rem; outline:none; margin-top:8px; display:block;}
.input:focus{border-color:var(--glow); box-shadow:0 0 10px rgba(0,196,255,0.2)}
.btn{display:block; width:100%; margin-top:18px; padding:14px; border-radius:10px; font-weight:800; background:linear-gradient(135deg,var(--glow),var(--light)); color:var(--accent-dark); border:none; cursor:pointer; box-shadow:0 0 20px rgba(0,196,255,0.2); transition:transform 0.2s}
.btn:hover{transform:scale(1.02); filter:brightness(1.1)}
.btn-ghost{background:transparent; border:1px solid rgba(255,255,255,0.2); color:var(--muted); padding:10px; width:100%; margin-top:10px; border-radius:10px; cursor:pointer}

/* Feedback & Muro */
.result-box{margin-top:16px; padding:14px; border-radius:12px; text-align:center; font-weight:bold}
.ok{background:rgba(0,50,60,0.6); color:#9effd8; border:1px solid #9effd8}
.fail{background:rgba(50,10,10,0.6); color:#ff9b9b; border:1px solid #ff9b9b}
.hidden{display:none !important}

/* Muro */
.muroside{max-height:500px; overflow-y:auto}
.name-item{padding:12px; margin:8px 0; border-radius:8px; background:linear-gradient(90deg, rgba(0,200,255,0.05), transparent); border-bottom:1px solid rgba(255,255,255,0.05); animation:fadeIn 0.5s ease}
.name-glow{color:var(--light); font-weight:bold; font-size:1.1rem}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}

/* Overlay */
#ritualOverlay{position:fixed; inset:0; z-index:99; background:radial-gradient(circle, rgba(0,10,20,0.95), black); display:none; align-items:center; justify-content:center; flex-direction:column}

/* ========== RESPONSIVE ADICIONAL ========== */
@media (max-width: 768px) {
    header {
        padding: 15px 15px 5px !important;
    }
    
    .wrap {
        margin: 10px auto 20px !important;
        padding: 15px !important;
    }
    
    .title {
        font-size: 1.8rem !important;
    }
    
    .subtitle {
        font-size: 0.9rem !important;
    }
    
    .card {
        padding: 18px !important;
    }
    
    .grid {
        gap: 15px !important;
    }
}

@media (max-height: 700px) {
    header {
        padding-top: 15px !important;
        padding-bottom: 5px !important;
    }
    
    .wrap {
        margin-top: 10px !important;
        margin-bottom: 20px !important;
    }
    
    .muroside {
        max-height: 300px !important;
    }
}
</style>
</head>
<body>

<canvas id="bgCanvas"></canvas>
<div class="water-overlay"></div>

<header>
    <div class="title">El Pacto Azul</div>
    <div class="subtitle">Ritual Sagrado ‚Äî Inscribe tu nombre en el Registro Azul Hist√≥rico</div>
</header>

<main class="wrap">
    <section class="grid">
        
        <div class="card">
            <h2 class="center" style="color:var(--glow)">üîë Acceso Sagrado</h2>
            
            <div id="faseCodigo">
                <p class="center" style="color:var(--muted)">Introduce tu c√≥digo de Guardi√°n para abrir el portal.</p>
                <input id="codigoInput" class="input" type="text" placeholder="Ej: GPR-AQUA-0021">
                <button class="btn" id="btnValidar">Validar C√≥digo</button>
                <div id="resultado" class="result-box hidden"></div>
            </div>

            <div id="faseFirma" class="hidden">
                <h3 class="center" style="color:var(--light)">‚úçÔ∏è Firma el Pacto</h3>
                <p class="center" style="color:var(--muted); font-size:0.9rem">Tu nombre ser√° sellado para siempre.</p>
                
                <input id="nombreInput" class="input" type="text" placeholder="Tu Nombre Completo *">
                <input id="paisInput" class="input" type="text" placeholder="Pa√≠s / Ciudad (Opcional)">
                <input id="notaInput" class="input" type="text" placeholder="Mensaje para el futuro (Opcional)">
                
                <button class="btn" id="btnFirmar">SELLAR FIRMA</button>
                <button class="btn-ghost" id="btnCancelar">Cancelar</button>
            </div>

            <div id="seal" class="hidden center" style="margin-top:20px">
                <svg width="100" height="100" viewBox="0 0 100 100" style="filter:drop-shadow(0 0 10px #00c4ff)">
                    <circle cx="50" cy="50" r="45" fill="none" stroke="#00c4ff" stroke-width="2"/>
                    <path d="M30 50 Q50 20 70 50 T30 50" fill="none" stroke="#8feaff" stroke-width="2"/>
                </svg>
                <p style="color:#00c4ff; font-weight:bold">REGISTRO COMPLETADO</p>
            </div>
        </div>

        <aside class="card muroside">
            <h2 class="center" style="color:var(--glow)">üåê Muro del Pacto</h2>
            <div id="muro">
                <div class="center" style="padding:20px; color:var(--muted)">Conectando...</div>
            </div>
            <button class="btn-ghost" id="btnActualizar">‚Üª Actualizar Lista</button>
        </aside>

    </section>

    <section id="accesosBox" class="card hidden center" style="max-width:800px; margin:20px auto;">
        <h2>üéâ ¬°Bienvenido Guardi√°n!</h2>
        <p style="color:var(--muted); margin-bottom: 20px;">Tu firma ha sido sellada. Ahora tienes acceso total al ecosistema BlueSphere.</p>
        
        <div style="display:flex; gap:15px; justify-content:center; flex-wrap: wrap;">
            <a id="btnCertificado" href="#" target="_blank" class="btn" style="width:auto; text-decoration:none; min-width:160px; display:inline-block;">
                üìú Descargar Certificado
            </a>
            
            <a id="btnBiblioteca" href="modulo-biblioteca.html" target="_blank" class="btn" style="width:auto; text-decoration:none; min-width:160px; display:inline-block; text-align:center;">
                üìö Biblioteca
            </a>

            <a id="btnSeguimiento" href="modulo-seguimiento.html" target="_blank" class="btn" style="width:auto; text-decoration:none; min-width:160px; display:inline-block; text-align:center;">
                üîÅ Seguimiento
            </a>

            <a id="btnDashboard" href="dashboard-global-impacto.html" target="_blank" class="btn" style="width:auto; text-decoration:none; min-width:160px; display:inline-block; text-align:center;">
                üåç Dashboard
            </a>
        </div>
    </section>
</main>

<div id="ritualOverlay">
    <h2 style="color:var(--glow); font-size:2rem">Procesando...</h2>
    <p style="color:var(--muted)">Consultando la base de datos</p>
</div>

<script type="module">
// ==================== CONFIGURACI√ìN SUPABASE ====================
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

// TUS CREDENCIALES
const supabaseUrl = "https://ophicpcbgdgzthjamzoz.supabase.co";
const supabaseAnonKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9waGljcGNiZ2RnenRoamFtem96Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ3MjgwMzUsImV4cCI6MjA4MDMwNDAzNX0.K55Tk-cdbAFDOtGrIMN7vYFaJAccrsD6UdOrARt1P5c";

const supabase = createClient(supabaseUrl, supabaseAnonKey);
console.log('‚úÖ Supabase inicializado correctamente');

// ==================== ELEMENTOS DOM ====================
const muroEl = document.getElementById('muro');
const resultadoEl = document.getElementById('resultado');
const faseCodigo = document.getElementById('faseCodigo');
const faseFirma = document.getElementById('faseFirma');
const seal = document.getElementById('seal');
const accesosBox = document.getElementById('accesosBox');
const ritualOverlay = document.getElementById('ritualOverlay');

// ==================== VARIABLES GLOBALES ====================
let codigoValidado = false;
let codigoActual = '';

// ==================== FUNCIONES ====================

// ==================== FUNCIONES PRINCIPALES ====================

// 1. VALIDAR C√ìDIGO (SIN CAMBIOS - SE MANTIENE IGUAL)
async function validarCodigo() {
    const codigo = document.getElementById('codigoInput').value.trim();
    if(!codigo) return mostrarError('Ingresa un c√≥digo');

    codigoActual = codigo;
    mostrarCarga(true, "Verificando c√≥digo...");

    try {
        const { data, error } = await supabase
            .from('codigos')
            .select('*')
            .eq('codigo', codigo)
            .single();

        mostrarCarga(false);

        if (error || !data) {
            mostrarError('‚ùå C√≥digo no v√°lido o no encontrado.');
            codigoValidado = false;
        } else {
            resultadoEl.className = 'hidden';
            faseCodigo.classList.add('hidden');
            faseFirma.classList.remove('hidden');
            codigoValidado = true;
        }
    } catch (err) {
        mostrarCarga(false);
        mostrarError('‚ùå Error de conexi√≥n con la base de datos');
        console.error('Error validando c√≥digo:', err);
    }
}

// 2. FIRMAR PACTO (VERSI√ìN MEJORADA CON ANIMACI√ìN)
async function startRitual() {
    // ==================== 1. VALIDACIONES INICIALES ====================
    if(!codigoValidado) {
        alert('Error de validaci√≥n: El c√≥digo no ha sido validado.');
        return;
    }
    
    const nombre = document.getElementById('nombreInput').value.trim();
    const pais = document.getElementById('paisInput').value.trim();
    const nota = document.getElementById('notaInput').value.trim();

    if(!nombre) {
        alert('El nombre es obligatorio para sellar el Pacto.');
        return;
    }

    // ==================== 2. ANIMACI√ìN DE SELLADO ====================
    const btnFirmar = document.getElementById('btnFirmar');
    const btnCancelar = document.getElementById('btnCancelar');
    const faseFirma = document.getElementById('faseFirma');
    
    // Guardar estado original
    const originalTexto = btnFirmar.textContent;
    const originalBackground = btnFirmar.style.background;
    
    // 2.1 CAMBIAR ESTADO DEL BOT√ìN
    btnFirmar.innerHTML = 'üïäÔ∏è <span class="sellando-texto">SELLANDO FIRMA...</span>';
    btnFirmar.style.background = 'linear-gradient(135deg, #0088cc, #006699)';
    btnFirmar.disabled = true;
    
    // 2.2 DESHABILITAR CANCELAR
    if(btnCancelar) btnCancelar.disabled = true;
    
    // 2.3 EFECTO VISUAL EN EL FORMULARIO COMPLETO
    faseFirma.style.opacity = '0.8';
    faseFirma.style.filter = 'blur(1px)';
    faseFirma.style.transition = 'all 0.5s ease';
    
    // 2.4 MOSTRAR INDICADOR DE PROGRESO
    mostrarCarga(true, "Sellando tu firma en el Registro Azul...");
    
    // 2.5 ANIMACI√ìN DE "ONDAS DE SELLADO" (visual)
    crearOndasDeSello();
    
    // ==================== 3. ESPERA DRAM√ÅTICA ====================
    await new Promise(resolve => setTimeout(resolve, 1800));
    
    // ==================== 4. PROCESO REAL EN SUPABASE ====================
    try {
        // 4.1 INSERTAR FIRMANTE
        const { error: errorFirma } = await supabase
            .from('firmantes')
            .insert([{ 
                nombre: nombre, 
                codigo_usado: codigoActual,
                pais: pais || null,
                nota: nota || null,
                fecha_firma: new Date().toISOString()
            }]);

        if (errorFirma) throw errorFirma;
        
        // 4.2 MARCAR C√ìDIGO COMO USADO
        const { error: errorCodigo } = await supabase
            .from('codigos')
            .update({ usado: true })
            .eq('codigo', codigoActual);
            
        if (errorCodigo) throw errorCodigo;
        
        // ==================== 5. √âXITO - TRANSICI√ìN ====================
        mostrarCarga(false);
        
        // 5.1 ANIMACI√ìN FINAL DE CONFIRMACI√ìN
        faseFirma.style.opacity = '0';
        faseFirma.style.filter = 'blur(3px)';
        
        setTimeout(() => {
            // Ocultar formulario
            faseFirma.classList.add('hidden');
            
            // Mostrar sello
            const seal = document.getElementById('seal');
            seal.classList.remove('hidden');
            seal.style.opacity = '0';
            seal.style.transform = 'scale(0.8)';
            
            // Animar aparici√≥n del sello
            setTimeout(() => {
                seal.style.transition = 'all 0.8s cubic-bezier(0.34, 1.56, 0.64, 1)';
                seal.style.opacity = '1';
                seal.style.transform = 'scale(1)';
                
                // A√±adir pulso al texto
                const textoCompletado = seal.querySelector('p');
                if(textoCompletado) {
                    textoCompletado.style.animation = 'pulse 2s infinite';
                }
                
                // Mostrar accesos
                const accesosBox = document.getElementById('accesosBox');
                accesosBox.classList.remove('hidden');
                
                // Configurar enlaces personalizados
                const btnCert = document.getElementById('btnCertificado');
                const btnDash = document.getElementById('btnDashboard');
                const btnBiblio = document.getElementById('btnBiblioteca');
                const btnSeg = document.getElementById('btnSeguimiento');
                
                if (btnCert) btnCert.href = `certificado-bluesphere.html?nombre=${encodeURIComponent(nombre)}&codigo=${encodeURIComponent(codigoActual)}`;
                if (btnDash) btnDash.href = `dashboard-global-impacto.html?usuario=${encodeURIComponent(nombre)}`;
                if (btnBiblio) btnBiblio.href = `modulo-biblioteca.html?codigo=${encodeURIComponent(codigoActual)}`;
                if (btnSeg) btnSeg.href = `modulo-seguimiento.html?codigo=${encodeURIComponent(codigoActual)}`;
                
                // Actualizar muro con nuevo guardi√°n destacado
                setTimeout(() => cargarMuro(), 500);
                
            }, 100);
        }, 500);
        
    } catch (err) {
        // ==================== 6. ERROR - RESTAURAR ESTADO ====================
        mostrarCarga(false);
        
        // Restaurar formulario
        faseFirma.style.opacity = '1';
        faseFirma.style.filter = 'none';
        
        // Restaurar botones
        btnFirmar.textContent = originalTexto;
        btnFirmar.style.background = originalBackground;
        btnFirmar.disabled = false;
        if(btnCancelar) btnCancelar.disabled = false;
        
        // Mostrar error
        alert('‚ùå El sello no pudo completarse: ' + (err.message || 'Error desconocido'));
        console.error('Error en startRitual:', err);
    }
}

// 3. CARGAR MURO (VERSI√ìN MEJORADA CON DESTAQUE)
async function cargarMuro() {
    muroEl.innerHTML = '<div class="center" style="color:var(--muted)">Actualizando...</div>';
    
    try {
        const { data, error } = await supabase
            .from('firmantes')
            .select('nombre, fecha_firma')
            .order('fecha_firma', { ascending: false })
            .limit(20);

        if (error) throw error;

        if (!data || data.length === 0) {
            muroEl.innerHTML = '<div class="center" style="color:var(--muted)">S√© el primero en firmar.</div>';
        } else {
            muroEl.innerHTML = '';
            data.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'name-item name-glow';
                div.textContent = item.nombre;
                
                // Destacar el M√ÅS RECIENTE (primer elemento)
                if (index === 0) {
                    div.classList.add('nuevo-guardian');
                    setTimeout(() => {
                        div.classList.remove('nuevo-guardian');
                    }, 8000);
                }
                
                muroEl.appendChild(div);
            });
        }
    } catch (error) {
        console.error('Error cargando muro:', error);
        muroEl.innerHTML = '<div class="center fail">Error de conexi√≥n</div>';
    }
}

// ==================== FUNCIONES UTILER√çA ====================
function mostrarError(msg) {
    resultadoEl.textContent = msg;
    resultadoEl.className = 'result-box fail';
    resultadoEl.classList.remove('hidden');
}

function mostrarCarga(show, msg) {
    ritualOverlay.style.display = show ? 'flex' : 'none';
    if(msg && ritualOverlay.querySelector('h2')) {
        ritualOverlay.querySelector('h2').textContent = msg;
    }
}

function cancelarFirma() {
    faseFirma.classList.add('hidden');
    faseCodigo.classList.remove('hidden');
    resultadoEl.classList.add('hidden');
}

// ==================== FUNCIONES AUXILIARES NUEVAS ====================
function crearOndasDeSello() {
    const faseFirma = document.getElementById('faseFirma');
    if(!faseFirma) return;
    
    // Crear elemento de ondas
    const ondas = document.createElement('div');
    ondas.className = 'ondas-sello';
    ondas.style.cssText = `
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 100px;
        height: 100px;
        border-radius: 50%;
        border: 3px solid rgba(0, 196, 255, 0.6);
        z-index: 10;
        pointer-events: none;
        animation: expandirOnda 1.5s ease-out forwards;
    `;
    
    faseFirma.appendChild(ondas);
    
    // Remover despu√©s de la animaci√≥n
    setTimeout(() => {
        if(ondas.parentNode) ondas.parentNode.removeChild(ondas);
    }, 1500);
}

// ==================== EVENT LISTENERS ====================
document.addEventListener('DOMContentLoaded', async () => {
    // A√±adir CSS de animaciones
    agregarCSSAnimaciones();
    
    // Configurar botones
    document.getElementById('btnValidar').addEventListener('click', validarCodigo);
    document.getElementById('btnFirmar').addEventListener('click', startRitual);
    document.getElementById('btnCancelar').addEventListener('click', cancelarFirma);
    document.getElementById('btnActualizar').addEventListener('click', cargarMuro);
    
    // Cargar muro inicial
    await cargarMuro();
});

// ==================== ANIMACI√ìN FONDO (SIN CAMBIOS) ====================
const canvas = document.getElementById('bgCanvas');
const ctx = canvas.getContext('2d');
let w, h, stars = [];

function initStars() {
    w = canvas.width = innerWidth; 
    h = canvas.height = innerHeight;
    stars = [];
    for(let i = 0; i < 80; i++) {
        stars.push({
            x: Math.random() * w,
            y: Math.random() * h,
            s: Math.random() * 0.5
        });
    }
}

function draw() {
    ctx.clearRect(0, 0, w, h);
    ctx.fillStyle = "#8feaff";
    stars.forEach(p => { 
        p.y -= p.s; 
        if(p.y < 0) p.y = h; 
        ctx.beginPath(); 
        ctx.arc(p.x, p.y, Math.random() * 2, 0, Math.PI * 2); 
        ctx.fill(); 
    });
    requestAnimationFrame(draw);
}

initStars();
draw();
window.addEventListener('resize', initStars);

// ==================== CSS ADICIONAL ====================
function agregarCSSAnimaciones() {
    if(!document.getElementById('animaciones-sello')) {
        const css = `
            /* ANIMACI√ìN DE SELLADO */
            .sellando-texto {
                display: inline-block;
                animation: parpadeoSutil 1.5s infinite;
            }
            
            @keyframes parpadeoSutil {
                0%, 100% { opacity: 1; }
                50% { opacity: 0.7; }
            }
            
            @keyframes expandirOnda {
                0% {
                    width: 10px;
                    height: 10px;
                    opacity: 1;
                    border-width: 2px;
                }
                100% {
                    width: 300px;
                    height: 300px;
                    opacity: 0;
                    border-width: 1px;
                }
            }
            
            @keyframes pulse {
                0% { 
                    text-shadow: 0 0 5px #00c4ff;
                    transform: scale(1);
                }
                50% { 
                    text-shadow: 0 0 20px #00c4ff, 0 0 30px #00c4ff;
                    transform: scale(1.05);
                }
                100% { 
                    text-shadow: 0 0 5px #00c4ff;
                    transform: scale(1);
                }
            }
            
            /* DESTAQUE PARA NUEVO GUARDI√ÅN */
            .nuevo-guardian {
                background: linear-gradient(90deg, 
                    rgba(0, 196, 255, 0.15), 
                    rgba(0, 150, 255, 0.25), 
                    rgba(0, 196, 255, 0.15)
                ) !important;
                border: 1px solid #00c4ff !important;
                transform: scale(1.02);
                box-shadow: 0 5px 20px rgba(0, 196, 255, 0.3);
                animation: nuevoDestello 3s ease-in-out;
            }
            
            @keyframes nuevoDestello {
                0% { box-shadow: 0 0 0 0 rgba(0, 196, 255, 0); }
                50% { box-shadow: 0 0 30px 10px rgba(0, 196, 255, 0.3); }
                100% { box-shadow: 0 5px 20px rgba(0, 196, 255, 0.3); }
            }
        `;
        
        const style = document.createElement('style');
        style.id = 'animaciones-sello';
        style.textContent = css;
        document.head.appendChild(style);
    }
}

// ==================== EXPORTAR FUNCIONES ====================
window.validarCodigo = validarCodigo;
window.startRitual = startRitual;
window.cancelarFirma = cancelarFirma;
window.cargarMuro = cargarMuro;
