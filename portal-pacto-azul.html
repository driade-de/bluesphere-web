<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Portal del Pacto Azul ‚Äî Ritual Sagrado</title>
<meta name="description" content="Portal del Pacto Azul ‚Äî Ritual sagrado para inscribir nombres en el Registro Azul Hist√≥rico."/>
<style>
:root{
  --bg:#010912;
  --card: rgba(6,30,40,0.55);
  --glow:#00c4ff;
  --light:#8feaff;
  --muted:#b7e9ff;
  --accent-dark:#002731;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  background: radial-gradient(circle at 15% 10%, rgba(0,120,180,0.06), transparent), radial-gradient(circle at 85% 80%, rgba(0,40,90,0.06), transparent), var(--bg);
  color:#eaffff; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  overflow-x:hidden;
}
#bgCanvas{position:fixed; inset:0; z-index:0; pointer-events:none}
.water-overlay{position:fixed; inset:0; z-index:0; pointer-events:none; mix-blend-mode:screen; opacity:0.95}
.water-overlay::before{content:""; position:absolute; inset:0; background: radial-gradient(circle at 30% 20%, rgba(0,120,180,0.05), transparent 10%), radial-gradient(circle at 80% 80%, rgba(0,60,140,0.05), transparent 15%); transform: translateY(0); animation: drift 18s linear infinite}
@keyframes drift{0%{transform:translateY(0)}50%{transform:translateY(-12px)}100%{transform:translateY(0)}}
header{position:relative; z-index:2; padding:36px 20px 6px; text-align:center}
.title{font-size:2.4rem; color:var(--glow); font-weight:900; letter-spacing:1px; text-shadow:0 0 18px rgba(0,180,255,0.18)}
.subtitle{color:var(--muted); margin-top:6px}
.wrap{position:relative; z-index:2; max-width:1100px; margin:28px auto 80px; padding:24px}
.card{background:var(--card); border-radius:16px; padding:20px; margin-bottom:20px; border:1px solid rgba(255,255,255,0.04); box-shadow:0 12px 40px rgba(0,10,20,0.5); backdrop-filter: blur(6px) saturate(120%)}
.grid{display:grid; grid-template-columns:1fr 420px; gap:18px; align-items:start}
@media(max-width:920px){ .grid{grid-template-columns:1fr} }
.center{text-align:center}
.input{width:78%; max-width:600px; padding:12px 14px; border-radius:10px; border:1px solid rgba(255,255,255,0.06); background:rgba(2,26,34,0.6); color:#eaffff; font-size:1rem; outline:none}
.btn{display:inline-block; margin-top:14px; padding:11px 18px; border-radius:10px; font-weight:800; background:linear-gradient(135deg,var(--glow),var(--light)); color:var(--accent-dark); border:none; cursor:pointer; box-shadow:0 6px 18px rgba(0,160,255,0.06)}
.btn-ghost{display:inline-block; margin-top:12px; padding:10px 14px; border-radius:10px; font-weight:700; color:var(--muted); border:1px solid rgba(255,255,255,0.04); background:transparent; cursor:pointer}
.result-box{margin-top:16px; padding:14px; border-radius:12px; text-align:center; background:linear-gradient(180deg, rgba(0,30,40,0.14), rgba(0,10,20,0.14)); border:1px solid rgba(0,180,255,0.04)}
.ok{color:#9effd8; font-weight:800}
.fail{color:#ff9b9b; font-weight:800}
.firma-area{margin-top:18px; text-align:center}
#nombreDisplay{font-weight:900; font-size:1.4rem; color:var(--light); letter-spacing:0.6px; text-shadow:0 0 12px rgba(0,180,255,0.12)}
#nameTrace{position:relative; height:72px; display:flex; align-items:center; justify-content:center; margin-top:12px}
.name-letter{display:inline-block; opacity:0; transform: translateY(12px) rotateX(15deg); color:var(--light); font-weight:900; font-size:1.4rem; text-shadow:0 0 18px rgba(0,200,255,0.12); filter:drop-shadow(0 6px 18px rgba(0,160,255,0.06))}
.travel-clone{position:fixed; z-index:60; pointer-events:none; transform-origin:left top; will-change:transform,opacity}
#seal{width:120px;height:120px;margin:18px auto 6px; opacity:0; transform:scale(0.6); transition:transform .6s cubic-bezier(.2,.9,.3,1), opacity .4s}
#seal svg{width:100%;height:100%; filter: drop-shadow(0 12px 26px rgba(0,160,255,0.08))}
.muroside{max-height:520px; overflow:auto; padding:12px; border-radius:12px; background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.01)); border:1px solid rgba(255,255,255,0.02)}
.name-list{column-count:1; column-gap:12px; color:var(--light); font-size:1rem; line-height:1.6; padding:8px}
@media(min-width:920px){ .name-list{column-count:2} }
.name-item{display:block; padding:8px 10px; margin:6px 0; border-radius:8px; background:linear-gradient(90deg, rgba(0,200,255,0.02), rgba(0,120,180,0.02)); transition: transform .22s ease, box-shadow .22s ease}
.name-item:hover{transform:translateY(-6px) scale(1.01); box-shadow:0 12px 30px rgba(0,160,255,0.06)}
.name-glow{color:var(--light); font-weight:800; text-shadow:0 0 18px rgba(0,180,255,0.18), 0 0 8px rgba(0,120,255,0.08)}
#ritualOverlay{position:fixed; inset:0; z-index:70; display:none; align-items:center; justify-content:center; background: radial-gradient(circle at center, rgba(0,10,20,0.75), rgba(0,0,0,0.9)); color:#e7fffb; backdrop-filter: blur(4px)}
.ritual-card{width:92%; max-width:720px; text-align:center; background:linear-gradient(180deg, rgba(6,18,24,0.6), rgba(6,10,14,0.6)); border-radius:14px; padding:26px; border:1px solid rgba(0,200,255,0.06); box-shadow:0 18px 60px rgba(0,160,255,0.08)}
.ritual-title{font-size:1.5rem; font-weight:900; color:var(--glow); margin-bottom:8px}
.ritual-sub{color:var(--muted); margin-bottom:14px}
.small{font-size:0.9rem; color:var(--muted)}
.fade-in{animation:fadeIn .45s ease both}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
</style>
</head>
<body>

<canvas id="bgCanvas" aria-hidden="true"></canvas>
<div class="water-overlay" aria-hidden="true"></div>

<header>
  <div class="title">El Pacto Azul</div>
  <div class="subtitle">Ritual Sagrado ‚Äî Inscribe tu nombre en el Registro Azul Hist√≥rico</div>
</header>

<main class="wrap" role="main" aria-labelledby="main-title">

  <section class="card" id="introCard">
    <h2 id="main-title">üåä El Llamado</h2>
    <p class="small">Firmar el Pacto Azul es un acto de conciencia. Cuando escribes tu nombre, declaras que ser√°s Guardi√°n. Hazlo con intenci√≥n. Conserva tu c√≥digo seguro.</p>
  </section>

  <section class="grid">

    <!-- Left: ritual -->
    <div class="card" aria-labelledby="accesoTitle">
      <h2 id="accesoTitle">üîë Acceso Sagrado</h2>
      <p class="small">Introduce el c√≥digo que recibiste como donante o inversor. Solo c√≥digos autorizados pueden activar la firma ritual.</p>

      <div class="center" style="margin-top:14px">
        <input id="codigoInput" class="input" type="text" placeholder="Ej: BS-PZ-2026-000123-AZUL" aria-label="C√≥digo del Pacto Azul">
        <div style="margin-top:10px">
          <button class="btn" onclick="validarCodigo()">Validar C√≥digo</button>
          <button class="btn-ghost" onclick="openHelp()">¬øNo tienes c√≥digo?</button>
        </div>
        <div id="resultado" class="result-box hidden" role="status" aria-live="polite"></div>
      </div>

      <!-- Firma -->
      <div id="firmaBox" class="fade-in hidden" style="margin-top:16px">
        <h3 class="small">‚úçÔ∏è Firma el Pacto</h3>
        <p class="small">Escribe tu nombre exactamente como quieres que aparezca en el Registro Azul Hist√≥rico.</p>
        <div class="firma-area">
          <input id="nombreInput" class="input" type="text" placeholder="Tu nombre completo ‚Äî Ej: Ana L√≥pez (M√©xico)">
          <div id="nameTrace" aria-hidden="true"></div>
          <div style="margin-top:8px">
            <button class="btn" onclick="startRitual()">Firmar Pacto Azul</button>
            <button class="btn-ghost" onclick="cancelarFirma()">Cancelar</button>
          </div>
        </div>

        <div class="small" style="margin-top:10px">Puedes activar la m√∫sica ambiental para una experiencia completa (opcional).</div>
        <div style="margin-top:8px" class="audio-bar">
          <button id="audioToggle" class="btn-ghost" onclick="toggleAudio()">üîä M√∫sica ambiental: OFF</button>
        </div>

      </div>

      <!-- seal preview -->
      <div id="seal" class="hidden" aria-hidden="true">
        <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <defs>
            <linearGradient id="g1" x1="0" x2="1">
              <stop offset="0" stop-color="#7ef3ff"/>
              <stop offset="1" stop-color="#00bcd4"/>
            </linearGradient>
          </defs>
          <circle cx="50" cy="50" r="46" fill="none" stroke="url(#g1)" stroke-width="2.8"/>
          <path d="M20 62 C36 44, 64 44, 80 62" fill="none" stroke="url(#g1)" stroke-width="3.4" stroke-linecap="round"/>
          <circle cx="34" cy="38" r="2.8" fill="#7ef3ff"/>
          <circle cx="66" cy="38" r="2.8" fill="#7ef3ff"/>
        </svg>
      </div>

    </div>

    <!-- Right: muro -->
    <aside class="muroside card" aria-labelledby="muroTitle">
      <h2 id="muroTitle">üåê Muro del Pacto Azul</h2>
      <p class="small">Los nombres que sostienen el despertar de la conciencia planetaria. Tu firma aparecer√° aqu√≠ cuando se confirme.</p>
      <div id="muro" class="name-list" aria-live="polite"></div>
      <div style="margin-top:14px; text-align:center">
        <button class="btn-ghost" onclick="verTodos()">Ver listado completo</button>
        <button class="btn" onclick="exportNames()">üì§ Exportar (admin)</button>
      </div>
    </aside>

  </section>

  <!-- accesos tras firma -->
  <section id="accesosBox" class="card hidden" aria-hidden="true" style="text-align:center">
    <h2>üéâ Bienvenido, Guardi√°n del Pacto Azul</h2>
    <p class="small">Tu firma ha sido registrada. Accede a tus recursos y comparte tu pertenencia al Pacto.</p>
    <div style="display:flex; gap:12px; flex-wrap:wrap; justify-content:center; margin-top:12px">
      <a class="btn" href="certificado-bluesphere.html" target="_blank" rel="noopener">üìú Descargar Certificado</a>
      <a class="btn" href="modulo-biblioteca.html" target="_blank" rel="noopener">üìö Biblioteca</a>
      <a class="btn" href="modulo-seguimiento.html" target="_blank" rel="noopener">üîÅ Seguimiento</a>
      <a class="btn" href="dashboard-global-impacto.html" target="_blank" rel="noopener">üåç Dashboard</a>
    </div>
  </section>

</main>

<!-- ritual overlay -->
<div id="ritualOverlay" style="display:none;">
  <div class="ritual-card">
    <div class="ritual-title">Sellando tu Nombre</div>
    <div class="ritual-sub small">Un momento de silencio y presencia. Tu nombre se escribir√° en luz.</div>
    <div id="ritualAnim" style="margin-top:18px; height:120px; display:flex; align-items:center; justify-content:center">
      <svg width="200" height="60" viewBox="0 0 200 60" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <circle cx="40" cy="30" r="8" fill="#00e0ff"><animate attributeName="r" values="8;12;8" dur="1.4s" repeatCount="indefinite"/></circle>
        <circle cx="100" cy="30" r="6" fill="#7ef3ff"><animate attributeName="r" values="6;10;6" dur="1.2s" begin="0.2s" repeatCount="indefinite"/></circle>
        <circle cx="160" cy="30" r="8" fill="#c8ffff"><animate attributeName="r" values="8;12;8" dur="1.5s" begin="0.4s" repeatCount="indefinite"/></circle>
      </svg>
    </div>
    <div id="ritualMsg" class="small" style="margin-top:10px; color:var(--muted)"></div>
  </div>
</div>

<audio id="ambientAudio" loop preload="auto">
  <source src="assets/audio/pacto_azul_ambient.mp3" type="audio/mpeg">
</audio>
<audio id="bellAudio" preload="auto">
  <source src="assets/audio/pacto_bell.mp3" type="audio/mpeg">
</audio>

<footer style="z-index:2; position:relative; text-align:center; color:var(--muted); margin-top:18px; padding-bottom:36px">
  ¬© 2025‚Äì2027 BlueSphere Consciousness ‚Äî Pacto Azul
  <div class="small" style="margin-top:6px">‚ÄúLa conciencia es la nueva civilizaci√≥n.‚Äù</div>
</footer>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

const SUPABASE_URL = 'https://ophicpcbgdgzthjamzoz.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9waGljcGNiZ2RnenRoamtem96Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ3MjgwMzUsImV4cCI6MjA4MDMwNDAzNX0.K55Tk-cdbAFDOtGrIMN7vYFaJAccrsD6UdOrARt1P5c';
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const muroEl = document.getElementById('muro');
let firmantes = [];

function escapeHtml(s){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
function show(el){ el.classList.remove('hidden'); el.classList.add('fade-in'); }
function hide(el){ el.classList.add('hidden'); el.classList.remove('fade-in'); }
function sleep(ms){ return new Promise(res=>setTimeout(res,ms)); }

async function fetchMuro(){
  const { data, error } = await supabase.from('pacto_signatures').select('user_name').order('timestamp',{ascending:true});
  if(error){ console.error(error); return; }
  firmantes = data.map(d=>d.user_name);
  renderMuro();
}

function renderMuro(){
  if(!firmantes || firmantes.length===0){
    muroEl.innerHTML = '<div style="color:var(--muted); font-style:italic">A√∫n no hay firmas p√∫blicas. S√© el primero en firmar el Pacto Azul.</div>';
    return;
  }
  const reversed = firmantes.slice().reverse();
  muroEl.innerHTML = reversed.map(name => `<div class="name-item"><span class="name-glow">${escapeHtml(name)}</span></div>`).join('');
}
fetchMuro();

async function validarCodigo(){
  const codeInput = document.getElementById('codigoInput').value.trim();
  const res = document.getElementById('resultado');
  if(!codeInput){ res.className='result-box'; res.innerHTML='<div class="fail">‚ö† Ingresa tu c√≥digo.</div>'; res.classList.remove('hidden'); return; }

  const { data: codeData, error } = await supabase.from('blue_codes').select('*').eq('code_value', codeInput).single();
  if(error || !codeData){ res.className='result-box'; res.innerHTML='<div class="fail">‚ùå C√≥digo no reconocido. Contacta soporte.</div>'; res.classList.remove('hidden'); return; }
  if(codeData.is_redeemed){ res.className='result-box'; res.innerHTML='<div class="fail">‚ùå C√≥digo ya ha sido usado.</div>'; res.classList.remove('hidden'); return; }

  res.className='result-box'; res.innerHTML='<div class="ok">‚úî C√≥digo autorizado. Procede a la firma ritual.</div>'; res.classList.remove('hidden');
  document.getElementById('firmaBox').classList.remove('hidden');
}

async function startRitual(){
  const nombre = document.getElementById('nombreInput').value.trim();
  if(!nombre) return alert('Ingresa tu nombre para firmar el Pacto.');
  const codeInput = document.getElementById('codigoInput').value.trim();
  if(!codeInput) return alert('Ingresa tu c√≥digo primero.');

  const { data: codeData, error } = await supabase.from('blue_codes').select('*').eq('code_value', codeInput).single();
  if(error || !codeData){ alert('C√≥digo inv√°lido'); return; }
  if(codeData.is_redeemed){ alert('C√≥digo ya usado'); return; }

  document.getElementById('ritualOverlay').style.display='flex';
  document.getElementById('ritualMsg').textContent='Preparando el Registro Azul‚Ä¶';
  if(bell.src){ bell.currentTime=0; bell.play().catch(()=>{}); }

  animateNameTrace(nombre);
  await sleep(2000);

  document.getElementById('ritualMsg').textContent='Sellando tu presencia en la memoria colectiva‚Ä¶';
  await travelNameToMuro(nombre);

  const { data: sigData, error: sigError } = await supabase.from('pacto_signatures').insert([{ code_id: codeData.id, user_name: nombre, country:'Desconocido', timestamp: new Date() }]);
  if(sigError){ console.error(sigError); alert('Error al registrar firma'); return; }

  await supabase.from('blue_codes').update({is_redeemed:true, redeemed_by:nombre, redeemed_at:new Date()}).eq('id', codeData.id);

  firmantes.push(nombre);
  renderMuro();

  showSeal();
  document.getElementById('accesosBox').classList.remove('hidden');
  document.getElementById('ritualOverlay').style.display='none';
  burstParticles(120);

  const res = document.getElementById('resultado');
  res.className='result-box';
  res.innerHTML=`<div class="ok">‚úÖ Tu firma ha sido registrada en el Pacto Azul.</div>`;
  res.classList.remove('hidden');
  muroEl.scrollIntoView({behavior:'smooth', block:'center'});
}

const ambient = document.getElementById('ambientAudio');
const bell = document.getElementById('bellAudio');
let ambientOn=false;
function toggleAudio(){ if(!ambient.src){ alert('Audio no disponible'); return; } ambientOn=!ambientOn; ambientOn?ambient.play().catch(()=>{}):ambient.pause(); document.getElementById('audioToggle').textContent=`üîä M√∫sica ambiental: ${ambientOn?'ON':'OFF'}`; }

function animateNameTrace(name){ const trace=document.getElementById('nameTrace'); trace.innerHTML=''; Array.from(name).forEach((ch,i)=>{ const span=document.createElement('span'); span.className='name-letter'; span.textContent=ch; span.style.transition=`opacity .28s ease ${i*0.06}s, transform .36s cubic-bezier(.2,.9,.25,1) ${i*0.06}s, text-shadow .36s ${i*0.06}s`; trace.appendChild(span); }); requestAnimationFrame(()=>{ Array.from(trace.children).forEach((s)=>{ s.style.opacity=1; s.style.transform='translateY(0) rotateX(0)'; }); }); }

async function travelNameToMuro(name){ const clone=document.createElement('div'); clone.className='travel-clone name-letter'; clone.style.fontSize='1.6rem'; clone.style.padding='6px 8px'; clone.style.background='linear-gradient(90deg, rgba(0,200,255,0.03), rgba(0,120,200,0.03))'; clone.style.borderRadius='8px'; clone.style.opacity='0'; clone.textContent=name; document.body.appendChild(clone); const traceRect=document.getElementById('nameTrace').getBoundingClientRect(); clone.style.left=(traceRect.left+traceRect.width/2-60)+'px'; clone.style.top=(traceRect.top+traceRect.height/2-18)+'px'; clone.style.transform='translateZ(0) scale(1)'; clone.style.transition='transform 0.9s cubic-bezier(.2,.85,.25,1), opacity 0.6s ease, left 0.9s, top 0.9s'; requestAnimationFrame(()=>{ clone.style.opacity='1'; clone.style.transform='translateY(-6px) scale(1.02)'; }); await sleep(700); const muroRect=muroEl.getBoundingClientRect(); clone.style.left=(muroRect.left+20)+'px'; clone.style.top=(muroRect.top+20)+'px'; clone.style.transform='translateY(-4px) scale(0.86)'; clone.style.opacity='0.92'; await sleep(900); clone.style.opacity='0'; clone.style.transform='scale(0.6) translateY(-10px)'; setTimeout(()=>clone.remove(),500); }

function cancelarpFirma(){ document.getElementById('firmaBox').classList.add('hidden'); }

document.getElementById('codigoInput').addEventListener('keydown', e=>{ if(e.key==='Enter') validarCodigo(); });
document.getElementById('nombreInput').addEventListener('keydown', e=>{ if(e.key==='Enter') startRitual(); });

function showSeal(){ const s=document.getElementById('seal'); s.classList.remove('hidden'); s.style.opacity='1'; s.style.transform='scale(1)'; }
function burstParticles(n){ /* Aqu√≠ puedes a√±adir animaci√≥n de part√≠culas si quieres */ }
function openHelp(){ alert('Contacta a soporte: soporte@bluesphere.org'); }
function verTodos(){ window.scrollTo({top:0, behavior:'smooth'}); }
function exportNames(){ alert('Funcionalidad solo para administradores.'); }
</script>

</body>
</html>
