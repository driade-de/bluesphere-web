<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recepción de Código — BlueSphere</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>

    <style>
        /* ESTILO GHIBLI DARK */
        body {
            margin: 0;
            background: #010912;
            color: white;
            font-family: sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            background: radial-gradient(circle, #0b2d3d 0%, #010912 100%);
        }
        .card {
            background: rgba(6, 30, 40, 0.9);
            padding: 40px;
            border-radius: 20px;
            border: 1px solid #00c4ff;
            text-align: center;
            max-width: 400px;
            box-shadow: 0 0 50px rgba(0, 196, 255, 0.2);
        }
        h1 { color: #00c4ff; margin-top: 0; }
        input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            border: 1px solid #005f73;
            background: rgba(0,0,0,0.5);
            color: white;
            box-sizing: border-box; /* Importante para que no se salga */
        }
        button {
            background: linear-gradient(90deg, #00c4ff, #00ffaa);
            border: none;
            padding: 15px;
            width: 100%;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
            font-size: 1rem;
        }
        button:hover { transform: scale(1.02); }
        
        .codigo-final {
            font-size: 1.5rem;
            color: #00ffaa;
            margin: 20px 0;
            font-weight: bold;
            font-family: monospace;
            border: 1px dashed #00ffaa;
            padding: 10px;
            border-radius: 10px;
        }
    </style>
</head>
<body>

    <div class="card" id="card-registro">
        <h1>¡GRACIAS GUARDIÁN!</h1>
        <p>Tu donación ha sido recibida. Genera tu llave de acceso ahora.</p>
        
        <input type="text" id="nombre" placeholder="Tu Nombre">
        <button onclick="generar()">OBTENER CÓDIGO</button>
        <p id="msg" style="color: #ff6b6b; font-size: 0.9rem;"></p>
    </div>

    <div class="card" id="card-exito" style="display: none;">
        <h1>✨ TU CÓDIGO ✨</h1>
        <p>Copia y guarda este código:</p>
        <div class="codigo-final" id="codigo-resultado">...</div>
        <button onclick="window.location.href='portal-pacto-azul.html'">IR AL PORTAL ➔</button>
    </div>

    <script>
        // CLIENTE SUPABASE
        const supabaseUrl = 'https://ophicpcbgdgzthjamzoz.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9waGljcGNiZ2RnenRoamFtem96Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ3MjgwMzUsImV4cCI6MjA4MDMwNDAzNX0.K55Tk-cdbAFDOtGrIMN7vYFaJAccrsD6UdOrARt1P5c';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        async function generar() {
            const nombre = document.getElementById('nombre').value;
            const btn = document.querySelector('button');
            const msg = document.getElementById('msg');

            if(!nombre) {
                msg.innerText = "Escribe tu nombre por favor.";
                return;
            }

            btn.innerText = "Generando...";
            btn.disabled = true;

            try {
                // Insertamos solo nombre y estatus. El trigger pone el código.
                const { data, error } = await supabase
                    .from('codigos_gpr')
                    .insert([{ nombre: nombre, estatus: 'disponible' }])
                    .select();

                if(error) throw error;

                // ÉXITO
                if(data && data.length > 0) {
                    const codigo = data[0].codigo;
                    document.getElementById('card-registro').style.display = 'none';
                    document.getElementById('card-exito').style.display = 'block';
                    document.getElementById('codigo-resultado').innerText = codigo;
                }

            } catch(e) {
                console.error(e);
                msg.innerText = "Error: " + e.message;
                btn.innerText = "INTENTAR DE NUEVO";
                btn.disabled = false;
            }
        }
    </script>

</body>
</html>
